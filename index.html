<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>活動記録</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: auto;
      background: #f5f6fa;
      color: #333;
      padding: 15px; /* 全体のパディングを追加 */
      box-sizing: border-box; /* パディングを考慮したサイズ計算 */
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #4a90e2;
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px; /* 下部に余白を追加 */
    }
    header h1 {
      font-size: 1.4em;
      margin: 0;
    }
    .top-icons a {
      margin-left: 10px;
      color: white;
      font-size: 1.4em;
      text-decoration: none;
      padding: 5px; /* クリックしやすいようにパディング */
    }
    .date-picker {
      display: block;
      margin: 16px 0;
      font-size: 1em;
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box; /* パディングを考慮したサイズ計算 */
    }
    .hour-block {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      overflow: hidden; /* 子要素のmarginがはみ出さないように */
    }
    .hour-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #f0f4f8;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
    }
    .compact {
      display: none;
      padding: 10px 12px;
      font-size: 0.95em;
      color: #555;
      line-height: 1.5; /* 行の高さを調整 */
    }
    .hour-content {
      padding: 10px 12px;
    }
    .hour-content.hidden {
      display: none;
    }
    .checkbox-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .checkbox-grid label {
      background: #e8f0fe;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95em;
      display: flex;
      align-items: center;
      transition: background 0.2s; /* ホバー効果 */
    }
    .checkbox-grid label:hover {
        background: #d0e0fb;
    }
    .checkbox-grid input[type="checkbox"] {
      margin-right: 4px;
      cursor: pointer;
    }
    .flex-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      flex-wrap: wrap; /* スマホでの折り返し対応 */
    }
    .flex-row label {
      font-weight: bold;
      white-space: nowrap;
    }
    .flex-row select,
    .flex-row input[type="text"] {
      flex-grow: 1; /* スペースいっぱいに広がる */
      padding: 6px;
      font-size: 0.95em;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box; /* パディングを考慮したサイズ計算 */
      min-width: 80px; /* 最小幅を設定 */
    }
    .save-btn {
      background: #4a90e2;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.2s; /* ホバー効果 */
      margin-top: 5px; /* 上部に少し余白 */
    }
    .save-btn:hover {
      background: #3b78c5;
    }
    .daily-note {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      margin-top: 20px; /* 上部に余白を追加 */
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .daily-note label {
      display: flex; /* チェックボックスとテキストを揃える */
      align-items: center;
      margin-bottom: 6px;
      font-weight: bold;
    }
    .daily-note input[type="checkbox"] {
      margin-right: 6px;
      cursor: pointer;
    }
    .daily-note textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
      box-sizing: border-box; /* パディングを考慮したサイズ計算 */
      margin-top: 6px; /* 上部に余白を追加 */
      font-size: 0.95em;
    }
  </style>
</head>
<body>
  <header>
    <h1>活動記録</h1>
    <div class="top-icons">
      <a href="weekly.html" title="週間表示">📅</a>
      <a href="tags.html" title="タグ編集">⚙️</a>
    </div>
  </header>

  <input type="date" id="recordDate" class="date-picker">
  <div id="recordArea"></div>

  <div class="daily-note">
    <label><input type="checkbox" id="alcohol"> アルコール</label>
    <label><input type="checkbox" id="caffeine"> カフェイン</label>
    <label>上記摂取状況：</label>
    <textarea id="intakeMemo" rows="2" placeholder="アルコールやカフェインの含まれる飲料と量を具体的に記入"></textarea>
    <label>メモ・備考：</label>
    <textarea id="dailyMemo" rows="3" placeholder="自由記入"></textarea>
  </div>

  <script>
    // デフォルトタグの定義 (localStorageになければこれを使う)
    const defaultTags = ["起床","シャワー・風呂","朝食","昼食","夕食","外出","移動","個人課題","講義","帰宅","家事","休憩","就寝","薬","睡眠"];
    // localStorageからタグを読み込む。なければデフォルトタグを使用
    const tags = JSON.parse(localStorage.getItem("tags")) || defaultTags;
    // 気分・疲労度の選択肢 (0から100まで5刻み)
    const moods = Array.from({ length: 21 }, (_, i) => i * 5);

    // DOM要素の取得
    const recordArea = document.getElementById('recordArea');
    const alcoholChk = document.getElementById('alcohol');
    const caffeineChk = document.getElementById('caffeine');
    const intakeMemo = document.getElementById('intakeMemo'); // ★追加: 摂取状況メモ
    const dailyMemo = document.getElementById('dailyMemo');

    // 気分と疲労度の自動入力のために直前の値を保持する変数
    // この変数はrender()が呼ばれるたびにリセットされる
    let lastMood = 50;
    let lastFatigue = 50;

    /**
     * アプリのUIをレンダリング（描画）する関数
     * 選択されている日付に基づいて、LocalStorageからデータを読み込み、表示を更新する
     */
    function render() {
      const dateStr = document.getElementById('recordDate').value;
      // レンダリング開始時に現在の日のデータを全て読み込む
      // データが存在しない場合は空のオブジェクトを初期値とする
      const data = JSON.parse(localStorage.getItem(dateStr) || '{}');
      recordArea.innerHTML = ''; // 既存のUI要素を全てクリアして再生成

      // DailyNote（日ごとのメモ等）の表示とデータ読み込み
      if (data.dailyNote) {
        alcoholChk.checked = data.dailyNote.alcohol || false; // undefinedの場合はfalse
        caffeineChk.checked = data.dailyNote.caffeine || false; // undefinedの場合はfalse
        intakeMemo.value = data.dailyNote.intakeMemo || ''; // ★追加: 摂取状況メモの読み込み
        dailyMemo.value = data.dailyNote.memo || '';
      } else {
        // dailyNoteがない場合は初期状態にリセット
        alcoholChk.checked = false;
        caffeineChk.checked = false;
        intakeMemo.value = ''; // ★追加: 摂取状況メモのリセット
        dailyMemo.value = '';
      }

      // 気分と疲労度の自動入力のための初期値リセット
      lastMood = 50;
      lastFatigue = 50;

      // 24時間分の入力ブロックを生成
      for (let i = 0; i < 24; i++) {
        const hour = (i + 4) % 24; // 4時スタートで0-23時を順に処理
        const key = hour.toString().padStart(2,'0'); // "00", "01", ... "23"

        // 各時間帯のデータを取得。存在しない場合はデフォルト値で初期化
        let entry = data[key] || { activity: [], mood: 50, fatigue: 50, free:'', folded:false };

        // ★気分と疲労度の自動入力ロジック
        // 現在の時間帯のmood/fatigueがデフォルト値(50)であり、かつ「睡眠」ではない場合、直前の値を引き継ぐ
        // 最初の時間帯(i=0)は自動入力の対象外
        if (i > 0) {
            if (entry.mood === 50 && !entry.activity.includes("睡眠")) {
                entry.mood = lastMood;
            }
            if (entry.fatigue === 50 && !entry.activity.includes("睡眠")) {
                entry.fatigue = lastFatigue;
            }
        }
        // 現在の時間帯の気分と疲労度を次の時間帯のために保持
        // 空欄（''）の場合は引き継がない
        if (entry.mood !== '') {
            lastMood = entry.mood;
        }
        if (entry.fatigue !== '') {
            lastFatigue = entry.fatigue;
        }

        // --- UI要素の生成 ---
        const block = document.createElement('div');
        block.className = 'hour-block';

        const header = document.createElement('div');
        header.className = 'hour-header';
        header.textContent = `${key}:00`; // 時間表示

        const btn = document.createElement('button');
        btn.className = 'save-btn';
        btn.textContent = '保存する';

        // 折りたたみ時に表示されるコンパクトな情報
        const compact = document.createElement('div');
        compact.className = 'compact';
        compact.innerHTML = `
          <strong>やったこと:</strong> ${entry.activity.join(', ') || '―'}<br>
          <strong>気分:</strong> ${entry.mood === '' ? '―' : entry.mood}　<strong>疲労:</strong> ${entry.fatigue === '' ? '―' : entry.fatigue}<br>
          <strong>メモ:</strong> ${entry.free || '―'}
        `;

        // 展開時に表示される詳細入力フォーム
        const content = document.createElement('div');
        content.className = entry.folded ? 'hour-content hidden' : 'hour-content';

        // --- やったこと（チェックボックスグリッド）の生成 ---
        const ckGrid = document.createElement('div');
        ckGrid.className = 'checkbox-grid';
        tags.forEach(tag => {
          const lbl = document.createElement('label');
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.value = tag;
          chk.checked = entry.activity.includes(tag); // 既存のデータに基づいてチェック状態を設定
          
          // チェックボックスのクリックイベントが親のheaderのクリックイベントに伝播しないように停止
          chk.addEventListener('click', e => e.stopPropagation()); 
          
          // チェックボックスの状態変更時の処理
          chk.addEventListener('change', () => {
            if (chk.checked) {
              if (tag === "睡眠") {
                // 「睡眠」が選択されたら、他の全ての活動を解除し、「睡眠」のみにする
                entry.activity = ["睡眠"];
                // 気分・疲労度を空欄にし、UIも無効化
                selMood.value = '';
                selMood.disabled = true;
                selFat.value = '';
                selFat.disabled = true;
                // 他のチェックボックスの状態をUIに反映
                ckGrid.querySelectorAll('input[type="checkbox"]').forEach(otherChk => {
                  if (otherChk !== chk) {
                    otherChk.checked = false;
                  }
                });
              } else {
                // 「睡眠」以外のタグが選択されたら、「睡眠」タグを解除
                entry.activity = entry.activity.filter(t => t !== "睡眠");
                // 「睡眠」が解除されたので、気分・疲労度を有効化し、現在の値に戻す（デフォルト50）
                selMood.disabled = false;
                selFat.disabled = false;
                if (!entry.activity.includes(tag)) { // 既に含まれていなければ追加
                  entry.activity.push(tag);
                }
              }
            } else {
              // チェックが外されたらそのタグをactivityから削除
              entry.activity = entry.activity.filter(t => t !== tag);
              // もし「睡眠」が外された場合、気分・疲労度を有効化
              if (tag === "睡眠") {
                 selMood.disabled = false;
                 selFat.disabled = false;
              }
            }
          });
          lbl.appendChild(chk);
          lbl.appendChild(document.createTextNode(tag));
          ckGrid.appendChild(lbl);
        });

        // --- 自由記入欄の生成 ---
        const freeTxt = document.createElement('input');
        freeTxt.type = 'text';
        freeTxt.placeholder = '自由記入';
        freeTxt.value = entry.free; // 既存の値があれば設定
        freeTxt.addEventListener('input', () => {
          entry.free = freeTxt.value; // 入力内容をentryオブジェクトにリアルタイムで反映
        });

        // --- 気分・疲労度選択欄の生成 ---
        const row = document.createElement('div');
        row.className = 'flex-row';

        const moodLabel = document.createElement('label');
        moodLabel.textContent = "気分:";
        const selMood = document.createElement('select');
        moods.forEach(m => {
          const o = document.createElement('option');
          o.value = o.textContent = m;
          if (m === entry.mood) o.selected = true; // 既存の値に基づいて選択状態を設定
          selMood.appendChild(o);
        });
        // 「睡眠」が選択されている場合は気分を無効化
        if (entry.activity.includes("睡眠")) {
            selMood.value = '';
            selMood.disabled = true;
        } else {
            selMood.disabled = false;
        }
        // 気分の変更イベントリスナー
        selMood.addEventListener('change', () => {
            entry.mood = parseInt(selMood.value);
            // ユーザーが手動で変更したら、その値をlastMoodに設定し、自動入力の基準とする
            lastMood = entry.mood;
        });

        const fatigueLabel = document.createElement('label');
        fatigueLabel.textContent = "疲労度:";
        const selFat = document.createElement('select');
        moods.forEach(f => {
          const o = document.createElement('option');
          o.value = o.textContent = f;
          if (f === entry.fatigue) o.selected = true; // 既存の値に基づいて選択状態を設定
          selFat.appendChild(o);
        });
        // 「睡眠」が選択されている場合は疲労度を無効化
        if (entry.activity.includes("睡眠")) {
            selFat.value = '';
            selFat.disabled = true;
        } else {
            selFat.disabled = false;
        }
        // 疲労度の変更イベントリスナー
        selFat.addEventListener('change', () => {
            entry.fatigue = parseInt(selFat.value);
            // ユーザーが手動で変更したら、その値をlastFatigueに設定し、自動入力の基準とする
            lastFatigue = entry.fatigue;
        });

        row.append(moodLabel, selMood, fatigueLabel, selFat);
        
        // --- 各要素をcontentに追加 ---
        content.append(ckGrid, freeTxt, row, btn); 
        
        // --- headerとcontentをblockに追加 ---
        header.appendChild(btn.cloneNode(true)); // header内にも保存ボタン（ヘッダークリックでの保存用）
        header.lastChild.textContent = '保存'; // テキストを「保存」に変更（オプション）
        header.lastChild.className = 'save-btn-header'; // クラス名を変更して区別
        header.lastChild.style.marginLeft = 'auto'; // 右端に寄せる

        block.append(header, compact, content);
        recordArea.append(block);

        // --- イベントリスナーの設定 ---

        // 各時間帯のヘッダーをクリックで折りたたみ/展開
        header.onclick = () => {
          entry.folded = !entry.folded;
          // dataオブジェクト全体をlocalStorageから読み込み、現在の時間帯のentryを更新してから保存
          const currentDataOnHeaderClick = JSON.parse(localStorage.getItem(dateStr) || '{}');
          currentDataOnHeaderClick[key] = entry; // 現在のentryオブジェクトをcurrentDataOnHeaderClickに格納
          currentDataOnHeaderClick.dailyNote = currentDataOnHeaderClick.dailyNote || {}; // dailyNoteがなければ初期化
          currentDataOnHeaderClick.dailyNote.alcohol = alcoholChk.checked;
          currentDataOnHeaderClick.dailyNote.caffeine = caffeineChk.checked;
          currentDataOnHeaderClick.dailyNote.intakeMemo = intakeMemo.value; // ★追加: 摂取状況メモの保存
          currentDataOnHeaderClick.dailyNote.memo = dailyMemo.value;
          localStorage.setItem(dateStr, JSON.stringify(currentDataOnHeaderClick)); // currentDataOnHeaderClickを保存
          render(); // UIを再描画
        };

        // 各時間帯の保存ボタンをクリックで保存と折りたたみ
        btn.onclick = () => {
          // 保存ボタンが押されたときに、現在のUI上の値をデータに反映
          entry.mood = entry.activity.includes("睡眠") ? '' : (selMood.value === '' ? '' : parseInt(selMood.value));
          entry.fatigue = entry.activity.includes("睡眠") ? '' : (selFat.value === '' ? '' : parseInt(selFat.value));
          entry.free = freeTxt.value;
          entry.folded = true; // 保存時に折りたたむ
          
          // dataオブジェクト全体をlocalStorageから読み込み、現在の時間帯のentryを更新してから保存
          const currentData = JSON.parse(localStorage.getItem(dateStr) || '{}');
          currentData[key] = entry; // 現在のentryオブジェクトをcurrentDataに格納

          currentData.dailyNote = currentData.dailyNote || {}; // dailyNoteがなければ初期化
          currentData.dailyNote.alcohol = alcoholChk.checked;
          currentData.dailyNote.caffeine = caffeineChk.checked;
          currentData.dailyNote.intakeMemo = intakeMemo.value; // ★追加: 摂取状況メモの保存
          currentData.dailyNote.memo = dailyMemo.value;
          localStorage.setItem(dateStr, JSON.stringify(currentData)); // currentDataを保存
          render(); // 保存後にUIを再描画して最新の状態にする
        };

        // compact表示の制御
        compact.style.display = entry.folded ? 'block' : 'none';
        header.lastChild.style.display = entry.folded ? 'none' : 'block'; // 折りたたみ時はヘッダーの保存ボタンを非表示に
      }
    }

    // --- アプリ初期化とグローバルイベントリスナー ---

    // 日付選択のイベントリスナー (日付が変わったら再レンダリング)
    const dp = document.getElementById('recordDate');
    dp.value = new Date().toISOString().split('T')[0]; // 初期表示は今日の日付
    dp.onchange = render;

    // dailyNoteのチェックボックスとテキストエリアの変更イベントリスナー
    // これらの要素はrender()で再生成されないため、イベントリスナーは一度だけ設定すればOK
    // ただし、値を変更したら即座にlocalStorageに反映させる
    alcoholChk.addEventListener('change', () => {
      const dateStr = document.getElementById('recordDate').value;
      const data = JSON.parse(localStorage.getItem(dateStr) || '{}');
      data.dailyNote = data.dailyNote || {};
      data.dailyNote.alcohol = alcoholChk.checked;
      localStorage.setItem(dateStr, JSON.stringify(data));
    });

    caffeineChk.addEventListener('change', () => {
      const dateStr = document.getElementById('recordDate').value;
      const data = JSON.parse(localStorage.getItem(dateStr) || '{}');
      data.dailyNote = data.dailyNote || {};
      data.dailyNote.caffeine = caffeineChk.checked;
      localStorage.setItem(dateStr, JSON.stringify(data));
    });

    // ★追加: 摂取状況メモの入力イベントリスナー
    intakeMemo.addEventListener('input', () => {
      const dateStr = document.getElementById('recordDate').value;
      const data = JSON.parse(localStorage.getItem(dateStr) || '{}');
      data.dailyNote = data.dailyNote || {};
      data.dailyNote.intakeMemo = intakeMemo.value;
      localStorage.setItem(dateStr, JSON.stringify(data));
    });

    dailyMemo.addEventListener('input', () => {
      const dateStr = document.getElementById('recordDate').value;
      const data = JSON.parse(localStorage.getItem(dateStr) || '{}');
      data.dailyNote = data.dailyNote || {};
      data.dailyNote.memo = dailyMemo.value;
      localStorage.setItem(dateStr, JSON.stringify(data));
    });

    render(); // アプリ初期表示
  </script>
</body>
</html>
