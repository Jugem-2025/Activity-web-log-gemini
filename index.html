<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ´»å‹•è¨˜éŒ²</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: auto;
      background: #f5f6fa;
      color: #333;
      padding: 15px; /* å…¨ä½“ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¿½åŠ  */
      box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è€ƒæ…®ã—ãŸã‚µã‚¤ã‚ºè¨ˆç®— */
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #4a90e2;
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px; /* ä¸‹éƒ¨ã«ä½™ç™½ã‚’è¿½åŠ  */
    }
    header h1 {
      font-size: 1.4em;
      margin: 0;
    }
    .top-icons a {
      margin-left: 10px;
      color: white;
      font-size: 1.4em;
      text-decoration: none;
      padding: 5px; /* ã‚¯ãƒªãƒƒã‚¯ã—ã‚„ã™ã„ã‚ˆã†ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
    }
    .date-picker {
      display: block;
      margin: 16px 0;
      font-size: 1em;
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è€ƒæ…®ã—ãŸã‚µã‚¤ã‚ºè¨ˆç®— */
    }
    .hour-block {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      overflow: hidden; /* å­è¦ç´ ã®marginãŒã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã« */
    }
    .hour-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #f0f4f8;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
    }
    .compact {
      display: none;
      padding: 10px 12px;
      font-size: 0.95em;
      color: #555;
      line-height: 1.5; /* è¡Œã®é«˜ã•ã‚’èª¿æ•´ */
    }
    .hour-content {
      padding: 10px 12px;
    }
    .hour-content.hidden {
      display: none;
    }
    .checkbox-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .checkbox-grid label {
      background: #e8f0fe;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95em;
      display: flex;
      align-items: center;
      transition: background 0.2s; /* ãƒ›ãƒãƒ¼åŠ¹æœ */
    }
    .checkbox-grid label:hover {
        background: #d0e0fb;
    }
    .checkbox-grid input[type="checkbox"] {
      margin-right: 4px;
      cursor: pointer;
    }
    .flex-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      flex-wrap: wrap; /* ã‚¹ãƒãƒ›ã§ã®æŠ˜ã‚Šè¿”ã—å¯¾å¿œ */
    }
    .flex-row label {
      font-weight: bold;
      white-space: nowrap;
    }
    .flex-row select,
    .flex-row input[type="text"] {
      flex-grow: 1; /* ã‚¹ãƒšãƒ¼ã‚¹ã„ã£ã±ã„ã«åºƒãŒã‚‹ */
      padding: 6px;
      font-size: 0.95em;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è€ƒæ…®ã—ãŸã‚µã‚¤ã‚ºè¨ˆç®— */
      min-width: 80px; /* æœ€å°å¹…ã‚’è¨­å®š */
    }
    .save-btn {
      background: #4a90e2;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.2s; /* ãƒ›ãƒãƒ¼åŠ¹æœ */
      margin-top: 5px; /* ä¸Šéƒ¨ã«å°‘ã—ä½™ç™½ */
    }
    .save-btn:hover {
      background: #3b78c5;
    }
    .daily-note {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      margin-top: 20px; /* ä¸Šéƒ¨ã«ä½™ç™½ã‚’è¿½åŠ  */
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .daily-note label {
      display: flex; /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’æƒãˆã‚‹ */
      align-items: center;
      margin-bottom: 6px;
      font-weight: bold;
    }
    .daily-note input[type="checkbox"] {
      margin-right: 6px;
      cursor: pointer;
    }
    .daily-note textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
      box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è€ƒæ…®ã—ãŸã‚µã‚¤ã‚ºè¨ˆç®— */
      margin-top: 6px; /* ä¸Šéƒ¨ã«ä½™ç™½ã‚’è¿½åŠ  */
      font-size: 0.95em;
    }
  </style>
</head>
<body>
  <header>
    <h1>æ´»å‹•è¨˜éŒ²</h1>
    <div class="top-icons">
      <a href="weekly.html" title="é€±é–“è¡¨ç¤º">ğŸ“…</a>
      <a href="tags.html" title="ã‚¿ã‚°ç·¨é›†">âš™ï¸</a>
    </div>
  </header>

  <input type="date" id="recordDate" class="date-picker">
  <div id="recordArea"></div>

  <div class="daily-note">
    <label><input type="checkbox" id="alcohol"> ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«</label>
    <label><input type="checkbox" id="caffeine"> ã‚«ãƒ•ã‚§ã‚¤ãƒ³</label>
    <label>ä¸Šè¨˜æ‘‚å–çŠ¶æ³ï¼š</label>
    <textarea id="intakeMemo" rows="2" placeholder="ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ã‚„ã‚«ãƒ•ã‚§ã‚¤ãƒ³ã®å«ã¾ã‚Œã‚‹é£²æ–™ã¨é‡ã‚’å…·ä½“çš„ã«è¨˜å…¥"></textarea>
    <label>ãƒ¡ãƒ¢ãƒ»å‚™è€ƒï¼š</label>
    <textarea id="dailyMemo" rows="3" placeholder="è‡ªç”±è¨˜å…¥"></textarea>
  </div>

  <script>
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚°ã®å®šç¾© (localStorageã«ãªã‘ã‚Œã°ã“ã‚Œã‚’ä½¿ã†)
    const defaultTags = ["èµ·åºŠ","ã‚·ãƒ£ãƒ¯ãƒ¼ãƒ»é¢¨å‘‚","æœé£Ÿ","æ˜¼é£Ÿ","å¤•é£Ÿ","å¤–å‡º","ç§»å‹•","å€‹äººèª²é¡Œ","è¬›ç¾©","å¸°å®…","å®¶äº‹","ä¼‘æ†©","å°±å¯","è–¬","ç¡çœ "];
    // localStorageã‹ã‚‰ã‚¿ã‚°ã‚’èª­ã¿è¾¼ã‚€ã€‚ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚°ã‚’ä½¿ç”¨
    const tags = JSON.parse(localStorage.getItem("tags")) || defaultTags;
    // æ°—åˆ†ãƒ»ç–²åŠ´åº¦ã®é¸æŠè‚¢ (0ã‹ã‚‰100ã¾ã§5åˆ»ã¿)
    const moods = Array.from({ length: 21 }, (_, i) => i * 5);

    // DOMè¦ç´ ã®å–å¾—
    const recordArea = document.getElementById('recordArea');
    const alcoholChk = document.getElementById('alcohol');
    const caffeineChk = document.getElementById('caffeine');
    const intakeMemo = document.getElementById('intakeMemo'); // â˜…è¿½åŠ : æ‘‚å–çŠ¶æ³ãƒ¡ãƒ¢
    const dailyMemo = document.getElementById('dailyMemo');

    // æ°—åˆ†ã¨ç–²åŠ´åº¦ã®è‡ªå‹•å…¥åŠ›ã®ãŸã‚ã«ç›´å‰ã®å€¤ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
    // ã“ã®å¤‰æ•°ã¯render()ãŒå‘¼ã°ã‚Œã‚‹ãŸã³ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹
    let lastMood = 50;
    let lastFatigue = 50;

    /**
     * ã‚¢ãƒ—ãƒªã®UIã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆæç”»ï¼‰ã™ã‚‹é–¢æ•°
     * é¸æŠã•ã‚Œã¦ã„ã‚‹æ—¥ä»˜ã«åŸºã¥ã„ã¦ã€LocalStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹
     */
    function render() {
      const dateStr = document.getElementById('recordDate').value;
      // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹æ™‚ã«ç¾åœ¨ã®æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦èª­ã¿è¾¼ã‚€
      // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸå€¤ã¨ã™ã‚‹
      const data = JSON.parse(localStorage.getItem(dateStr) || '{}');
      recordArea.innerHTML = ''; // æ—¢å­˜ã®UIè¦ç´ ã‚’å…¨ã¦ã‚¯ãƒªã‚¢ã—ã¦å†ç”Ÿæˆ

      // DailyNoteï¼ˆæ—¥ã”ã¨ã®ãƒ¡ãƒ¢ç­‰ï¼‰ã®è¡¨ç¤ºã¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      if (data.dailyNote) {
        alcoholChk.checked = data.dailyNote.alcohol || false; // undefinedã®å ´åˆã¯false
        caffeineChk.checked = data.dailyNote.caffeine || false; // undefinedã®å ´åˆã¯false
        intakeMemo.value = data.dailyNote.intakeMemo || ''; // â˜…è¿½åŠ : æ‘‚å–çŠ¶æ³ãƒ¡ãƒ¢ã®èª­ã¿è¾¼ã¿
        dailyMemo.value = data.dailyNote.memo || '';
      } else {
        // dailyNoteãŒãªã„å ´åˆã¯åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ
        alcoholChk.checked = false;
        caffeineChk.checked = false;
        intakeMemo.value = ''; // â˜…è¿½åŠ : æ‘‚å–çŠ¶æ³ãƒ¡ãƒ¢ã®ãƒªã‚»ãƒƒãƒˆ
        dailyMemo.value = '';
      }

      // æ°—åˆ†ã¨ç–²åŠ´åº¦ã®è‡ªå‹•å…¥åŠ›ã®ãŸã‚ã®åˆæœŸå€¤ãƒªã‚»ãƒƒãƒˆ
      lastMood = 50;
      lastFatigue = 50;

      // 24æ™‚é–“åˆ†ã®å…¥åŠ›ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç”Ÿæˆ
      for (let i = 0; i < 24; i++) {
        const hour = (i + 4) % 24; // 4æ™‚ã‚¹ã‚¿ãƒ¼ãƒˆã§0-23æ™‚ã‚’é †ã«å‡¦ç†
        const key = hour.toString().padStart(2,'0'); // "00", "01", ... "23"

        // å„æ™‚é–“å¸¯ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã€‚å­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§åˆæœŸåŒ–
        let entry = data[key] || { activity: [], mood: 50, fatigue: 50, free:'', folded:false };

        // â˜…æ°—åˆ†ã¨ç–²åŠ´åº¦ã®è‡ªå‹•å…¥åŠ›ãƒ­ã‚¸ãƒƒã‚¯
        // ç¾åœ¨ã®æ™‚é–“å¸¯ã®mood/fatigueãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤(50)ã§ã‚ã‚Šã€ã‹ã¤ã€Œç¡çœ ã€ã§ã¯ãªã„å ´åˆã€ç›´å‰ã®å€¤ã‚’å¼•ãç¶™ã
        // æœ€åˆã®æ™‚é–“å¸¯(i=0)ã¯è‡ªå‹•å…¥åŠ›ã®å¯¾è±¡å¤–
        if (i > 0) {
            if (entry.mood === 50 && !entry.activity.includes("ç¡çœ ")) {
                entry.mood = lastMood;
            }
            if (entry.fatigue === 50 && !entry.activity.includes("ç¡çœ ")) {
                entry.fatigue = lastFatigue;
            }
        }
        // ç¾åœ¨ã®æ™‚é–“å¸¯ã®æ°—åˆ†ã¨ç–²åŠ´åº¦ã‚’æ¬¡ã®æ™‚é–“å¸¯ã®ãŸã‚ã«ä¿æŒ
        // ç©ºæ¬„ï¼ˆ''ï¼‰ã®å ´åˆã¯å¼•ãç¶™ãŒãªã„
        if (entry.mood !== '') {
            lastMood = entry.mood;
        }
        if (entry.fatigue !== '') {
            lastFatigue = entry.fatigue;
        }

        // --- UIè¦ç´ ã®ç”Ÿæˆ ---
        const block = document.createElement('div');
        block.className = 'hour-block';

        const header = document.createElement('div');
        header.className = 'hour-header';
        header.textContent = `${key}:00`; // æ™‚é–“è¡¨ç¤º

        const btn = document.createElement('button');
        btn.className = 'save-btn';
        btn.textContent = 'ä¿å­˜ã™ã‚‹';

        // æŠ˜ã‚ŠãŸãŸã¿æ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªæƒ…å ±
        const compact = document.createElement('div');
        compact.className = 'compact';
        compact.innerHTML = `
          <strong>ã‚„ã£ãŸã“ã¨:</strong> ${entry.activity.join(', ') || 'â€•'}<br>
          <strong>æ°—åˆ†:</strong> ${entry.mood === '' ? 'â€•' : entry.mood}ã€€<strong>ç–²åŠ´:</strong> ${entry.fatigue === '' ? 'â€•' : entry.fatigue}<br>
          <strong>ãƒ¡ãƒ¢:</strong> ${entry.free || 'â€•'}
        `;

        // å±•é–‹æ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹è©³ç´°å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
        const content = document.createElement('div');
        content.className = entry.folded ? 'hour-content hidden' : 'hour-content';

        // --- ã‚„ã£ãŸã“ã¨ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚°ãƒªãƒƒãƒ‰ï¼‰ã®ç”Ÿæˆ ---
        const ckGrid = document.createElement('div');
        ckGrid.className = 'checkbox-grid';
        tags.forEach(tag => {
          const lbl = document.createElement('label');
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.value = tag;
          chk.checked = entry.activity.includes(tag); // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’è¨­å®š
          
          // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦ªã®headerã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã«ä¼æ’­ã—ãªã„ã‚ˆã†ã«åœæ­¢
          chk.addEventListener('click', e => e.stopPropagation()); 
          
          // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹å¤‰æ›´æ™‚ã®å‡¦ç†
          chk.addEventListener('change', () => {
            if (chk.checked) {
              if (tag === "ç¡çœ ") {
                // ã€Œç¡çœ ã€ãŒé¸æŠã•ã‚ŒãŸã‚‰ã€ä»–ã®å…¨ã¦ã®æ´»å‹•ã‚’è§£é™¤ã—ã€ã€Œç¡çœ ã€ã®ã¿ã«ã™ã‚‹
                entry.activity = ["ç¡çœ "];
                // æ°—åˆ†ãƒ»ç–²åŠ´åº¦ã‚’ç©ºæ¬„ã«ã—ã€UIã‚‚ç„¡åŠ¹åŒ–
                selMood.value = '';
                selMood.disabled = true;
                selFat.value = '';
                selFat.disabled = true;
                // ä»–ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’UIã«åæ˜ 
                ckGrid.querySelectorAll('input[type="checkbox"]').forEach(otherChk => {
                  if (otherChk !== chk) {
                    otherChk.checked = false;
                  }
                });
              } else {
                // ã€Œç¡çœ ã€ä»¥å¤–ã®ã‚¿ã‚°ãŒé¸æŠã•ã‚ŒãŸã‚‰ã€ã€Œç¡çœ ã€ã‚¿ã‚°ã‚’è§£é™¤
                entry.activity = entry.activity.filter(t => t !== "ç¡çœ ");
                // ã€Œç¡çœ ã€ãŒè§£é™¤ã•ã‚ŒãŸã®ã§ã€æ°—åˆ†ãƒ»ç–²åŠ´åº¦ã‚’æœ‰åŠ¹åŒ–ã—ã€ç¾åœ¨ã®å€¤ã«æˆ»ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ50ï¼‰
                selMood.disabled = false;
                selFat.disabled = false;
                if (!entry.activity.includes(tag)) { // æ—¢ã«å«ã¾ã‚Œã¦ã„ãªã‘ã‚Œã°è¿½åŠ 
                  entry.activity.push(tag);
                }
              }
            } else {
              // ãƒã‚§ãƒƒã‚¯ãŒå¤–ã•ã‚ŒãŸã‚‰ãã®ã‚¿ã‚°ã‚’activityã‹ã‚‰å‰Šé™¤
              entry.activity = entry.activity.filter(t => t !== tag);
              // ã‚‚ã—ã€Œç¡çœ ã€ãŒå¤–ã•ã‚ŒãŸå ´åˆã€æ°—åˆ†ãƒ»ç–²åŠ´åº¦ã‚’æœ‰åŠ¹åŒ–
              if (tag === "ç¡çœ ") {
                 selMood.disabled = false;
                 selFat.disabled = false;
              }
            }
          });
          lbl.appendChild(chk);
          lbl.appendChild(document.createTextNode(tag));
          ckGrid.appendChild(lbl);
        });

        // --- è‡ªç”±è¨˜å…¥æ¬„ã®ç”Ÿæˆ ---
        const freeTxt = document.createElement('input');
        freeTxt.type = 'text';
        freeTxt.placeholder = 'è‡ªç”±è¨˜å…¥';
        freeTxt.value = entry.free; // æ—¢å­˜ã®å€¤ãŒã‚ã‚Œã°è¨­å®š
        freeTxt.addEventListener('input', () => {
          entry.free = freeTxt.value; // å…¥åŠ›å†…å®¹ã‚’entryã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åæ˜ 
        });

        // --- æ°—åˆ†ãƒ»ç–²åŠ´åº¦é¸æŠæ¬„ã®ç”Ÿæˆ ---
        const row = document.createElement('div');
        row.className = 'flex-row';

        const moodLabel = document.createElement('label');
        moodLabel.textContent = "æ°—åˆ†:";
        const selMood = document.createElement('select');
        moods.forEach(m => {
          const o = document.createElement('option');
          o.value = o.textContent = m;
          if (m === entry.mood) o.selected = true; // æ—¢å­˜ã®å€¤ã«åŸºã¥ã„ã¦é¸æŠçŠ¶æ…‹ã‚’è¨­å®š
          selMood.appendChild(o);
        });
        // ã€Œç¡çœ ã€ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ°—åˆ†ã‚’ç„¡åŠ¹åŒ–
        if (entry.activity.includes("ç¡çœ ")) {
            selMood.value = '';
            selMood.disabled = true;
        } else {
            selMood.disabled = false;
        }
        // æ°—åˆ†ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        selMood.addEventListener('change', () => {
            entry.mood = parseInt(selMood.value);
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§å¤‰æ›´ã—ãŸã‚‰ã€ãã®å€¤ã‚’lastMoodã«è¨­å®šã—ã€è‡ªå‹•å…¥åŠ›ã®åŸºæº–ã¨ã™ã‚‹
            lastMood = entry.mood;
        });

        const fatigueLabel = document.createElement('label');
        fatigueLabel.textContent = "ç–²åŠ´åº¦:";
        const selFat = document.createElement('select');
        moods.forEach(f => {
          const o = document.createElement('option');
          o.value = o.textContent = f;
          if (f === entry.fatigue) o.selected = true; // æ—¢å­˜ã®å€¤ã«åŸºã¥ã„ã¦é¸æŠçŠ¶æ…‹ã‚’è¨­å®š
          selFat.appendChild(o);
        });
        // ã€Œç¡çœ ã€ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç–²åŠ´åº¦ã‚’ç„¡åŠ¹åŒ–
        if (entry.activity.includes("ç¡çœ ")) {
            selFat.value = '';
            selFat.disabled = true;
        } else {
            selFat.disabled = false;
        }
        // ç–²åŠ´åº¦ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        selFat.addEventListener('change', () => {
            entry.fatigue = parseInt(selFat.value);
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§å¤‰æ›´ã—ãŸã‚‰ã€ãã®å€¤ã‚’lastFatigueã«è¨­å®šã—ã€è‡ªå‹•å…¥åŠ›ã®åŸºæº–ã¨ã™ã‚‹
            lastFatigue = entry.fatigue;
        });

        row.append(moodLabel, selMood, fatigueLabel, selFat);
        
        // --- å„è¦ç´ ã‚’contentã«è¿½åŠ  ---
        content.append(ckGrid, freeTxt, row, btn); 
        
        // --- headerã¨contentã‚’blockã«è¿½åŠ  ---
        header.appendChild(btn.cloneNode(true)); // headerå†…ã«ã‚‚ä¿å­˜ãƒœã‚¿ãƒ³ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§ã®ä¿å­˜ç”¨ï¼‰
        header.lastChild.textContent = 'ä¿å­˜'; // ãƒ†ã‚­ã‚¹ãƒˆã‚’ã€Œä¿å­˜ã€ã«å¤‰æ›´ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        header.lastChild.className = 'save-btn-header'; // ã‚¯ãƒ©ã‚¹åã‚’å¤‰æ›´ã—ã¦åŒºåˆ¥
        header.lastChild.style.marginLeft = 'auto'; // å³ç«¯ã«å¯„ã›ã‚‹

        block.append(header, compact, content);
        recordArea.append(block);

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š ---

        // å„æ™‚é–“å¸¯ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã§æŠ˜ã‚ŠãŸãŸã¿/å±•é–‹
        header.onclick = () => {
          entry.folded = !entry.folded;
          // dataã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’localStorageã‹ã‚‰èª­ã¿è¾¼ã¿ã€ç¾åœ¨ã®æ™‚é–“å¸¯ã®entryã‚’æ›´æ–°ã—ã¦ã‹ã‚‰ä¿å­˜
          const currentDataOnHeaderClick = JSON.parse(localStorage.getItem(dateStr) || '{}');
          currentDataOnHeaderClick[key] = entry; // ç¾åœ¨ã®entryã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’currentDataOnHeaderClickã«æ ¼ç´
          currentDataOnHeaderClick.dailyNote = currentDataOnHeaderClick.dailyNote || {}; // dailyNoteãŒãªã‘ã‚Œã°åˆæœŸåŒ–
          currentDataOnHeaderClick.dailyNote.alcohol = alcoholChk.checked;
          currentDataOnHeaderClick.dailyNote.caffeine = caffeineChk.checked;
          currentDataOnHeaderClick.dailyNote.intakeMemo = intakeMemo.value; // â˜…è¿½åŠ : æ‘‚å–çŠ¶æ³ãƒ¡ãƒ¢ã®ä¿å­˜
          currentDataOnHeaderClick.dailyNote.memo = dailyMemo.value;
          localStorage.setItem(dateStr, JSON.stringify(currentDataOnHeaderClick)); // currentDataOnHeaderClickã‚’ä¿å­˜
          render(); // UIã‚’å†æç”»
        };

        // å„æ™‚é–“å¸¯ã®ä¿å­˜ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ä¿å­˜ã¨æŠ˜ã‚ŠãŸãŸã¿
        btn.onclick = () => {
          // ä¿å­˜ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã«ã€ç¾åœ¨ã®UIä¸Šã®å€¤ã‚’ãƒ‡ãƒ¼ã‚¿ã«åæ˜ 
          entry.mood = entry.activity.includes("ç¡çœ ") ? '' : (selMood.value === '' ? '' : parseInt(selMood.value));
          entry.fatigue = entry.activity.includes("ç¡çœ ") ? '' : (selFat.value === '' ? '' : parseInt(selFat.value));
          entry.free = freeTxt.value;
          entry.folded = true; // ä¿å­˜æ™‚ã«æŠ˜ã‚ŠãŸãŸã‚€
          
          // dataã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’localStorageã‹ã‚‰èª­ã¿è¾¼ã¿ã€ç¾åœ¨ã®æ™‚é–“å¸¯ã®entryã‚’æ›´æ–°ã—ã¦ã‹ã‚‰ä¿å­˜
          const currentData = JSON.parse(localStorage.getItem(dateStr) || '{}');
          currentData[key] = entry; // ç¾åœ¨ã®entryã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’currentDataã«æ ¼ç´

          currentData.dailyNote = currentData.dailyNote || {}; // dailyNoteãŒãªã‘ã‚Œã°åˆæœŸåŒ–
          currentData.dailyNote.alcohol = alcoholChk.checked;
          currentData.dailyNote.caffeine = caffeineChk.checked;
          currentData.dailyNote.intakeMemo = intakeMemo.value; // â˜…è¿½åŠ : æ‘‚å–çŠ¶æ³ãƒ¡ãƒ¢ã®ä¿å­˜
          currentData.dailyNote.memo = dailyMemo.value;
          localStorage.setItem(dateStr, JSON.stringify(currentData)); // currentDataã‚’ä¿å­˜
          render(); // ä¿å­˜å¾Œã«UIã‚’å†æç”»ã—ã¦æœ€æ–°ã®çŠ¶æ…‹ã«ã™ã‚‹
        };

        // compactè¡¨ç¤ºã®åˆ¶å¾¡
        compact.style.display = entry.folded ? 'block' : 'none';
        header.lastChild.style.display = entry.folded ? 'none' : 'block'; // æŠ˜ã‚ŠãŸãŸã¿æ™‚ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¿å­˜ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«
      }
    }

    // --- ã‚¢ãƒ—ãƒªåˆæœŸåŒ–ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---

    // æ—¥ä»˜é¸æŠã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸã‚‰å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°)
    const dp = document.getElementById('recordDate');
    dp.value = new Date().toISOString().split('T')[0]; // åˆæœŸè¡¨ç¤ºã¯ä»Šæ—¥ã®æ—¥ä»˜
    dp.onchange = render;

    // dailyNoteã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    // ã“ã‚Œã‚‰ã®è¦ç´ ã¯render()ã§å†ç”Ÿæˆã•ã‚Œãªã„ãŸã‚ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯ä¸€åº¦ã ã‘è¨­å®šã™ã‚Œã°OK
    // ãŸã ã—ã€å€¤ã‚’å¤‰æ›´ã—ãŸã‚‰å³åº§ã«localStorageã«åæ˜ ã•ã›ã‚‹
    alcoholChk.addEventListener('change', () => {
      const dateStr = document.getElementById('recordDate').value;
      const data = JSON.parse(localStorage.getItem(dateStr) || '{}');
      data.dailyNote = data.dailyNote || {};
      data.dailyNote.alcohol = alcoholChk.checked;
      localStorage.setItem(dateStr, JSON.stringify(data));
    });

    caffeineChk.addEventListener('change', () => {
      const dateStr = document.getElementById('recordDate').value;
      const data = JSON.parse(localStorage.getItem(dateStr) || '{}');
      data.dailyNote = data.dailyNote || {};
      data.dailyNote.caffeine = caffeineChk.checked;
      localStorage.setItem(dateStr, JSON.stringify(data));
    });

    // â˜…è¿½åŠ : æ‘‚å–çŠ¶æ³ãƒ¡ãƒ¢ã®å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    intakeMemo.addEventListener('input', () => {
      const dateStr = document.getElementById('recordDate').value;
      const data = JSON.parse(localStorage.getItem(dateStr) || '{}');
      data.dailyNote = data.dailyNote || {};
      data.dailyNote.intakeMemo = intakeMemo.value;
      localStorage.setItem(dateStr, JSON.stringify(data));
    });

    dailyMemo.addEventListener('input', () => {
      const dateStr = document.getElementById('recordDate').value;
      const data = JSON.parse(localStorage.getItem(dateStr) || '{}');
      data.dailyNote = data.dailyNote || {};
      data.dailyNote.memo = dailyMemo.value;
      localStorage.setItem(dateStr, JSON.stringify(data));
    });

    render(); // ã‚¢ãƒ—ãƒªåˆæœŸè¡¨ç¤º
  </script>
</body>
</html>
