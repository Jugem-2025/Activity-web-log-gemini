<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ´»å‹•è¨˜éŒ²</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: auto;
      background: #f5f6fa;
      color: #333;
      padding: 15px; /* å…¨ä½“ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¿½åŠ  */
      box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è€ƒæ…®ã—ãŸã‚µã‚¤ã‚ºè¨ˆç®— */
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #4a90e2;
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px; /* ä¸‹éƒ¨ã«ä½™ç™½ã‚’è¿½åŠ  */
    }
    header h1 {
      font-size: 1.4em;
      margin: 0;
    }
    .top-icons a {
      margin-left: 10px;
      color: white;
      font-size: 1.4em;
      text-decoration: none;
      padding: 5px; /* ã‚¯ãƒªãƒƒã‚¯ã—ã‚„ã™ã„ã‚ˆã†ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
    }
    .date-picker {
      display: block;
      margin: 16px 0;
      font-size: 1em;
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è€ƒæ…®ã—ãŸã‚µã‚¤ã‚ºè¨ˆç®— */
    }
    .hour-block {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      overflow: hidden; /* å­è¦ç´ ã®marginãŒã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã« */
    }
    .hour-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #f0f4f8;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
    }
    .hour-header .save-btn-header {
      background: #4a90e2;
      color: white;
      border: none;
      padding: 6px 12px; /* å°‘ã—å°ã•ã‚ã« */
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚‚èª¿æ•´ */
      transition: background 0.2s;
      margin-left: auto; /* å³ç«¯ã«å¯„ã›ã‚‹ */
      flex-shrink: 0; /* ç¸®ã¾ãªã„ã‚ˆã†ã« */
    }
    .hour-header .save-btn-header:hover {
      background: #3b78c5;
    }

    .compact {
      display: none;
      padding: 10px 12px;
      font-size: 0.95em;
      color: #555;
      line-height: 1.5; /* è¡Œã®é«˜ã•ã‚’èª¿æ•´ */
    }
    .hour-content {
      padding: 10px 12px;
    }
    .hour-content.hidden {
      display: none;
    }
    .checkbox-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }
    .checkbox-grid label {
      background: #e8f0fe;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95em;
      display: flex;
      align-items: center;
      transition: background 0.2s; /* ãƒ›ãƒãƒ¼åŠ¹æœ */
    }
    .checkbox-grid label:hover {
        background: #d0e0fb;
    }
    .checkbox-grid input[type="checkbox"] {
      margin-right: 4px;
      cursor: pointer;
    }
    .flex-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
      flex-wrap: wrap; /* ã‚¹ãƒãƒ›ã§ã®æŠ˜ã‚Šè¿”ã—å¯¾å¿œ */
    }
    .flex-row label {
      font-weight: bold;
      white-space: nowrap;
    }
    .flex-row select,
    .flex-row input[type="text"] {
      flex-grow: 1; /* ã‚¹ãƒšãƒ¼ã‚¹ã„ã£ã±ã„ã«åºƒãŒã‚‹ */
      padding: 6px;
      font-size: 0.95em;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è€ƒæ…®ã—ãŸã‚µã‚¤ã‚ºè¨ˆç®— */
      min-width: 80px; /* æœ€å°å¹…ã‚’è¨­å®š */
    }
    .daily-note {
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      margin-top: 20px; /* ä¸Šéƒ¨ã«ä½™ç™½ã‚’è¿½åŠ  */
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .daily-note label {
      display: flex; /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’æƒãˆã‚‹ */
      align-items: center;
      margin-bottom: 6px;
      font-weight: bold;
    }
    .daily-note input[type="checkbox"] {
      margin-right: 6px;
      cursor: pointer;
    }
    .daily-note textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
      box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è€ƒæ…®ã—ãŸã‚µã‚¤ã‚ºè¨ˆç®— */
      margin-top: 6px; /* ä¸Šéƒ¨ã«ä½™ç™½ã‚’è¿½åŠ  */
      font-size: 0.95em;
    }
    .daily-note-save-btn-wrapper {
        text-align: right; /* å³å¯„ã› */
        margin-top: 10px;
    }
    .daily-note-save-btn {
        background: #4a90e2;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1em;
        transition: background 0.2s;
    }
    .daily-note-save-btn:hover {
        background: #3b78c5;
    }
  </style>
</head>
<body>
  <header>
    <h1>æ´»å‹•è¨˜éŒ²</h1>
    <div class="top-icons">
      <a href="weekly.html" title="é€±é–“è¡¨ç¤º">ğŸ“…</a>
      <a href="tags.html" title="ã‚¿ã‚°ç·¨é›†">âš™ï¸</a>
    </div>
  </header>

  <input type="date" id="recordDate" class="date-picker">
  <div id="recordArea"></div>

  <div class="daily-note">
    <label><input type="checkbox" id="alcohol"> ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«</label>
    <label><input type="checkbox" id="caffeine"> ã‚«ãƒ•ã‚§ã‚¤ãƒ³</label>
    <label>ä¸Šè¨˜æ‘‚å–çŠ¶æ³ï¼š</label>
    <textarea id="intakeMemo" rows="2" placeholder="ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ã‚„ã‚«ãƒ•ã‚§ã‚¤ãƒ³ã®å«ã¾ã‚Œã‚‹é£²æ–™ã¨é‡ã‚’å…·ä½“çš„ã«è¨˜å…¥"></textarea>
    <label>ãƒ¡ãƒ¢ãƒ»å‚™è€ƒï¼š</label>
    <textarea id="dailyMemo" rows="3" placeholder="è‡ªç”±è¨˜å…¥"></textarea>
    <div class="daily-note-save-btn-wrapper">
        <button id="dailyNoteSaveBtn" class="daily-note-save-btn">ä¿å­˜ã™ã‚‹</button>
    </div>
  </div>

  <script>
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚°ã®å®šç¾© (localStorageã«ãªã‘ã‚Œã°ã“ã‚Œã‚’ä½¿ã†)
    const defaultTags = ["èµ·åºŠ","ã‚·ãƒ£ãƒ¯ãƒ¼ãƒ»é¢¨å‘‚","æœé£Ÿ","æ˜¼é£Ÿ","å¤•é£Ÿ","å¤–å‡º","ç§»å‹•","å€‹äººèª²é¡Œ","è¬›ç¾©","å¸°å®…","å®¶äº‹","ä¼‘æ†©","å°±å¯","è–¬","ç¡çœ "];
    // localStorageã‹ã‚‰ã‚¿ã‚°ã‚’èª­ã¿è¾¼ã‚€ã€‚ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚°ã‚’ä½¿ç”¨
    const tags = JSON.parse(localStorage.getItem("tags")) || defaultTags;
    // æ°—åˆ†ãƒ»ç–²åŠ´åº¦ã®é¸æŠè‚¢ (0ã‹ã‚‰100ã¾ã§5åˆ»ã¿)
    const moods = Array.from({ length: 21 }, (_, i) => i * 5);

    // DOMè¦ç´ ã®å–å¾—
    const recordArea = document.getElementById('recordArea');
    const alcoholChk = document.getElementById('alcohol');
    const caffeineChk = document.getElementById('caffeine');
    const intakeMemo = document.getElementById('intakeMemo');
    const dailyMemo = document.getElementById('dailyMemo');
    const dp = document.getElementById('recordDate');
    const dailyNoteSaveBtn = document.getElementById('dailyNoteSaveBtn'); // è¿½åŠ 

    // æ°—åˆ†ã¨ç–²åŠ´åº¦ã®è‡ªå‹•å…¥åŠ›ã®ãŸã‚ã«ç›´å‰ã®å€¤ã‚’ä¿æŒã™ã‚‹å¤‰æ•°
    let lastMood = 50;
    let lastFatigue = 50;
    
    // ãã®æ—¥ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ (ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã«LocalStorageã‹ã‚‰èª­ã¿è¾¼ã¿ã€å¤‰æ›´ã‚’éšæ™‚åæ˜ )
    let allDayData = {};

    // ç©ºã®æ´»å‹•è¨˜éŒ²ã‚¨ãƒ³ãƒˆãƒªã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
    const defaultEntry = { activity: [], mood: 50, fatigue: 50, free:'', folded:false };

    /**
     * ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãã®æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
     * @param {string} dateStr - æ—¥ä»˜æ–‡å­—åˆ— (YYYY-MM-DD)
     * @param {string} timeKey - æ™‚é–“å¸¯ã‚­ãƒ¼ (HH)ã€‚nullã®å ´åˆã¯dailyNoteã®ã¿æ›´æ–°
     * @param {object} entryData - ãã®æ™‚é–“å¸¯ã®ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚nullã®å ´åˆã¯dailyNoteã®ã¿æ›´æ–°
     * @param {object} dailyNoteData - ãã®æ—¥ã®ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã€‚nullã®å ´åˆã¯ç‰¹å®šã®æ™‚é–“å¸¯ãƒ‡ãƒ¼ã‚¿ã®ã¿æ›´æ–°
     */
    function saveToLocalStorage(dateStr, timeKey = null, entryData = null, dailyNoteData = null) {
        // ç¾åœ¨ãƒ¡ãƒ¢ãƒªä¸Šã«ã‚ã‚‹allDayDataã‚’ä½¿ç”¨
        let dataToSave = JSON.parse(JSON.stringify(allDayData)); // ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼ã—ã¦å¤‰æ›´ãŒå…ƒã®allDayDataã«å½±éŸ¿ã—ãªã„ã‚ˆã†ã«

        if (timeKey !== null && entryData !== null) {
            // ç‰¹å®šã®æ™‚é–“å¸¯ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            dataToSave[timeKey] = entryData;
        }

        if (dailyNoteData !== null) {
            // ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            dataToSave.dailyNote = dailyNoteData;
        }
        
        localStorage.setItem(dateStr, JSON.stringify(dataToSave));
    }

    /**
     * ã‚¨ãƒ³ãƒˆãƒªãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çŠ¶æ…‹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
     * @param {object} entry - ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚¨ãƒ³ãƒˆãƒªãƒ‡ãƒ¼ã‚¿
     * @returns {boolean} ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çŠ¶æ…‹ã§ã‚ã‚Œã°true
     */
    function isEntryDefault(entry) {
        if (!entry) return true; // ã‚¨ãƒ³ãƒˆãƒªè‡ªä½“ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

        // activityãŒç©ºã‹ã€"ç¡çœ "ã®ã¿ã§ä»–ã®æ´»å‹•ãŒãªãã€æ°—åˆ†ãƒ»ç–²åŠ´åº¦ãŒç©ºã§ã‚ã‚‹å ´åˆ
        const isActivitySleepDefault = entry.activity.length === 1 && entry.activity[0] === "ç¡çœ " && entry.mood === '' && entry.fatigue === '';
        const isActivityEmptyDefault = entry.activity.length === 0;

        // moodã¨fatigueãŒåˆæœŸå€¤ã®50ã§ã‚ã‚‹ã‹ã€ã¾ãŸã¯"ç¡çœ "ã®å ´åˆã¯ç©ºã§ã‚ã‚‹ã‹
        const isMoodFatigueDefault = (entry.mood === 50 && entry.fatigue === 50) || (entry.mood === '' && entry.fatigue === '' && entry.activity.includes("ç¡çœ "));
        
        // freeãŒç©ºã§ã‚ã‚‹ã‹
        const isFreeDefault = entry.free === '';

        // ã€Œç¡çœ ã€ã®ã¿ã§æ°—åˆ†ãƒ»ç–²åŠ´åº¦ãŒç©ºã®å ´åˆã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã¯ã¿ãªã•ãªã„ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯¾è±¡ã«ã™ã‚‹ï¼‰
        // ãã®ãŸã‚ã€isActivitySleepDefault ã®å ´åˆã¯ isEntryDefault ã¯ false ã«ãªã‚‹ã¹ã
        if (isActivitySleepDefault && isFreeDefault) {
             return false; // ã€Œç¡çœ ã€ã®ã¿ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ãªã„ã¨åˆ¤å®šã—ã€æŠ˜ã‚ŠãŸãŸã¿å¯¾è±¡ã¨ã™ã‚‹
        }
        
        return (isActivityEmptyDefault && isMoodFatigueDefault && isFreeDefault);
    }


    /**
     * ã‚¢ãƒ—ãƒªã®UIã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆæç”»ï¼‰ã™ã‚‹é–¢æ•°
     * é¸æŠã•ã‚Œã¦ã„ã‚‹æ—¥ä»˜ã«åŸºã¥ã„ã¦ã€LocalStorageã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹
     */
    function render() {
      const dateStr = dp.value;
      // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹æ™‚ã«ãã®æ—¥ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€allDayDataå¤‰æ•°ã«ä¿æŒ
      allDayData = JSON.parse(localStorage.getItem(dateStr) || '{}');
      recordArea.innerHTML = '';

      // Daily Noteã®å€¤ã‚’UIã«åæ˜ 
      const currentDailyNote = allDayData.dailyNote || {};
      alcoholChk.checked = currentDailyNote.alcohol || false;
      caffeineChk.checked = currentDailyNote.caffeine || false;
      intakeMemo.value = currentDailyNote.intakeMemo || '';
      dailyMemo.value = currentDailyNote.memo || '';

      // lastMoodã¨lastFatigueã¯ã€ãã®æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦åˆæœŸåŒ–
      lastMood = 50;
      lastFatigue = 50;

      for (let i = 0; i < 24; i++) {
        const hour = (i + 4) % 24; // 04:00ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
        const key = hour.toString().padStart(2,'0');

        let entry = allDayData[key] || JSON.parse(JSON.stringify(defaultEntry)); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¨ãƒ³ãƒˆãƒªã®ãƒ‡ã‚£ãƒ¼ãƒ—ã‚³ãƒ”ãƒ¼

        // ã€Œç¡çœ ã€ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€æ°—åˆ†ãƒ»ç–²åŠ´åº¦ã‚’ç©ºã«ã™ã‚‹
        if (entry.activity.includes("ç¡çœ ")) {
            entry.mood = '';
            entry.fatigue = '';
        } else {
            // ã€Œç¡çœ ã€ä»¥å¤–ã®å ´åˆã€mood/fatigueãŒæœªè¨­å®šï¼ˆåˆæœŸå€¤ã®50ä»¥å¤–ï¼‰ã§ã‚ã‚Œã°ç›´å‰ã®å€¤ã‚’é©ç”¨
            // ãŸã ã—ã€æ˜ç¤ºçš„ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã®å€¤ã‚’å„ªå…ˆ
            if (entry.mood === 50 && i > 0) { // åˆæœŸå€¤50ã®ã¾ã¾ã§ã€ã‹ã¤æœ€åˆã®ãƒ–ãƒ­ãƒƒã‚¯ã§ãªã‘ã‚Œã°
                entry.mood = lastMood;
            }
            if (entry.fatigue === 50 && i > 0) { // åˆæœŸå€¤50ã®ã¾ã¾ã§ã€ã‹ã¤æœ€åˆã®ãƒ–ãƒ­ãƒƒã‚¯ã§ãªã‘ã‚Œã°
                entry.fatigue = lastFatigue;
            }
        }
        
        // ç¾åœ¨ã®mood/fatigueã‚’æ¬¡ã®æ™‚é–“å¸¯ã®ãŸã‚ã«lastMood/lastFatigueã«è¨­å®š
        // ã€Œç¡çœ ã€ã§ã¯ãªã„å ´åˆã®ã¿æ›´æ–°ã™ã‚‹
        if (!entry.activity.includes("ç¡çœ ")) {
            // moodãŒç©ºã§ãªã‘ã‚Œã°ï¼ˆç©ºã¯ã€Œç¡çœ ä¸­ã€ã¾ãŸã¯æœªè¨­å®šã‚’æ„å‘³ã™ã‚‹ï¼‰
            if (entry.mood !== '') {
                lastMood = entry.mood;
            }
            if (entry.fatigue !== '') {
                lastFatigue = entry.fatigue;
            }
        }


        // --- UIè¦ç´ ã®ç”Ÿæˆ ---
        const block = document.createElement('div');
        block.className = 'hour-block';

        const header = document.createElement('div');
        header.className = 'hour-header';
        header.textContent = `${key}:00`;

        const saveBtnHeader = document.createElement('button');
        saveBtnHeader.className = 'save-btn-header';
        saveBtnHeader.textContent = 'ä¿å­˜ã™ã‚‹';
        saveBtnHeader.dataset.timeKey = key; // ä¿å­˜ãƒœã‚¿ãƒ³ã«æ™‚é–“å¸¯ã‚­ãƒ¼ã‚’æŒãŸã›ã‚‹

        const compact = document.createElement('div');
        compact.className = 'compact';
        
        const content = document.createElement('div');
        content.className = entry.folded ? 'hour-content hidden' : 'hour-content';

        const ckGrid = document.createElement('div');
        ckGrid.className = 'checkbox-grid';
        tags.forEach(tag => {
          const lbl = document.createElement('label');
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.value = tag;
          chk.checked = entry.activity.includes(tag);
          
          chk.addEventListener('click', e => e.stopPropagation()); // è¦ªè¦ç´ ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’åœæ­¢
          
          // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´æ™‚
          chk.addEventListener('change', () => {
            let currentEntry = allDayData[key] || JSON.parse(JSON.stringify(defaultEntry));
            
            if (chk.checked) {
              if (tag === "ç¡çœ ") {
                currentEntry.activity = ["ç¡çœ "]; // ç¡çœ ãŒé¸æŠã•ã‚ŒãŸã‚‰ä»–ã‚’å…¨ã¦è§£é™¤
                // UIä¸Šã®æ°—åˆ†ãƒ»ç–²åŠ´åº¦ã‚»ãƒ¬ã‚¯ã‚¿ã‚’æ›´æ–°ï¼ˆDOMè¦ç´ ç›´æ¥æ“ä½œï¼‰
                selMood.value = '';
                selMood.disabled = true;
                selFat.value = '';
                selFat.disabled = true;
                currentEntry.mood = ''; // ãƒ‡ãƒ¼ã‚¿ã‚‚ç©ºã«
                currentEntry.fatigue = ''; // ãƒ‡ãƒ¼ã‚¿ã‚‚ç©ºã«
                ckGrid.querySelectorAll('input[type="checkbox"]').forEach(otherChk => {
                  if (otherChk !== chk) {
                    otherChk.checked = false; // ä»–ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®UIã‚’æ›´æ–°
                  }
                });
              } else {
                // ç¡çœ ãŒé¸ã°ã‚Œã¦ã„ãŸã‚‰è§£é™¤ã—ã€é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™
                if (currentEntry.activity.includes("ç¡çœ ")) {
                  currentEntry.activity = [];
                  // UIä¸Šã®æ°—åˆ†ãƒ»ç–²åŠ´åº¦ã‚»ãƒ¬ã‚¯ã‚¿ã‚’æœ‰åŠ¹åŒ–
                  selMood.disabled = false;
                  selFat.disabled = false;
                  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ã‚»ãƒƒãƒˆ
                  currentEntry.mood = lastMood; // ç›´å‰ã®æ°—åˆ†ãƒ»ç–²åŠ´åº¦ã‚’é©ç”¨
                  currentEntry.fatigue = lastFatigue;
                  selMood.value = lastMood;
                  selFat.value = lastFatigue;
                }
                if (!currentEntry.activity.includes(tag)) {
                  currentEntry.activity.push(tag);
                }
              }
            } else { // ãƒã‚§ãƒƒã‚¯ãŒå¤–ã•ã‚ŒãŸå ´åˆ
              currentEntry.activity = currentEntry.activity.filter(t => t !== tag);
              if (tag === "ç¡çœ ") {
                 selMood.disabled = false;
                 selFat.disabled = false;
                 // ç¡çœ è§£é™¤æ™‚ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ã‚»ãƒƒãƒˆ
                 currentEntry.mood = lastMood; 
                 currentEntry.fatigue = lastFatigue;
                 selMood.value = lastMood;
                 selFat.value = lastFatigue;
              }
            }
            // allDayDataã‚’æ›´æ–°ã—ã¦ã‹ã‚‰ä¿å­˜
            allDayData[key] = currentEntry;
            saveToLocalStorage(dateStr, key, currentEntry); // ãã®æ™‚é–“å¸¯ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            updateCompactView(compact, currentEntry); // compactè¡¨ç¤ºã‚’æ›´æ–°
          });
          lbl.appendChild(chk);
          lbl.appendChild(document.createTextNode(tag));
          ckGrid.appendChild(lbl);
        });

        const freeTxt = document.createElement('input');
        freeTxt.type = 'text';
        freeTxt.placeholder = 'è‡ªç”±è¨˜å…¥';
        freeTxt.value = entry.free;
        // è‡ªç”±è¨˜å…¥æ¬„ã®å…¥åŠ›æ™‚
        freeTxt.addEventListener('input', () => {
          let currentEntry = allDayData[key] || JSON.parse(JSON.stringify(defaultEntry));
          currentEntry.free = freeTxt.value;
          allDayData[key] = currentEntry; // allDayDataã‚’æ›´æ–°
          saveToLocalStorage(dateStr, key, currentEntry); // ãã®æ™‚é–“å¸¯ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
          updateCompactView(compact, currentEntry); // å…¥åŠ›æ™‚ã«ã‚‚compactè¡¨ç¤ºã‚’æ›´æ–°
        });

        const row = document.createElement('div');
        row.className = 'flex-row';

        const moodLabel = document.createElement('label');
        moodLabel.textContent = "æ°—åˆ†:";
        const selMood = document.createElement('select');
        moods.forEach(m => {
          const o = document.createElement('option');
          o.value = o.textContent = m;
          // åˆæœŸè¡¨ç¤ºæ™‚ã®é¸æŠ
          if (entry.mood === m) o.selected = true;
          selMood.appendChild(o);
        });
        // ç¡çœ ä¸­ã®å ´åˆã®disabled/valueè¨­å®š
        if (entry.activity.includes("ç¡çœ ")) {
            selMood.value = '';
            selMood.disabled = true;
        } else {
            selMood.disabled = false;
            // moodãŒãƒ‡ãƒ¼ã‚¿ã«ãªã‘ã‚Œã°lastMoodã‚’åˆæœŸå€¤ã¨ã™ã‚‹
            if (entry.mood === undefined || entry.mood === null || entry.mood === '') {
                 selMood.value = lastMood;
                 entry.mood = lastMood; // ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
            }
        }
        // æ°—åˆ†é¸æŠã®å¤‰æ›´æ™‚
        selMood.addEventListener('change', () => {
            let currentEntry = allDayData[key] || JSON.parse(JSON.stringify(defaultEntry));
            currentEntry.mood = selMood.value === '' ? '' : parseInt(selMood.value);
            // lastMoodã‚’æ›´æ–° (æ¬¡ä»¥é™ã®ãƒ–ãƒ­ãƒƒã‚¯ã®åˆæœŸå€¤ã«å½±éŸ¿)
            if (currentEntry.mood !== '') {
                lastMood = currentEntry.mood;
            }
            allDayData[key] = currentEntry; // allDayDataã‚’æ›´æ–°
            saveToLocalStorage(dateStr, key, currentEntry); // ãã®æ™‚é–“å¸¯ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            updateCompactView(compact, currentEntry); // å¤‰æ›´æ™‚ã«ã‚‚compactè¡¨ç¤ºã‚’æ›´æ–°
        });

        const fatigueLabel = document.createElement('label');
        fatigueLabel.textContent = "ç–²åŠ´åº¦:";
        const selFat = document.createElement('select');
        moods.forEach(f => {
          const o = document.createElement('option');
          o.value = o.textContent = f;
          // åˆæœŸè¡¨ç¤ºæ™‚ã®é¸æŠ
          if (entry.fatigue === f) o.selected = true;
          selFat.appendChild(o);
        });
        // ç¡çœ ä¸­ã®å ´åˆã®disabled/valueè¨­å®š
        if (entry.activity.includes("ç¡çœ ")) {
            selFat.value = '';
            selFat.disabled = true;
        } else {
            selFat.disabled = false;
            // fatigueãŒãƒ‡ãƒ¼ã‚¿ã«ãªã‘ã‚Œã°lastFatigueã‚’åˆæœŸå€¤ã¨ã™ã‚‹
            if (entry.fatigue === undefined || entry.fatigue === null || entry.fatigue === '') {
                 selFat.value = lastFatigue;
                 entry.fatigue = lastFatigue; // ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
            }
        }
        // ç–²åŠ´åº¦é¸æŠã®å¤‰æ›´æ™‚
        selFat.addEventListener('change', () => {
            let currentEntry = allDayData[key] || JSON.parse(JSON.stringify(defaultEntry));
            currentEntry.fatigue = selFat.value === '' ? '' : parseInt(selFat.value);
            // lastFatigueã‚’æ›´æ–° (æ¬¡ä»¥é™ã®ãƒ–ãƒ­ãƒƒã‚¯ã®åˆæœŸå€¤ã«å½±éŸ¿)
            if (currentEntry.fatigue !== '') {
                lastFatigue = currentEntry.fatigue;
            }
            allDayData[key] = currentEntry; // allDayDataã‚’æ›´æ–°
            saveToLocalStorage(dateStr, key, currentEntry); // ãã®æ™‚é–“å¸¯ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            updateCompactView(compact, currentEntry); // å¤‰æ›´æ™‚ã«ã‚‚compactè¡¨ç¤ºã‚’æ›´æ–°
        });

        row.append(moodLabel, selMood, fatigueLabel, selFat);
        
        content.append(ckGrid, freeTxt, row);
        
        header.appendChild(saveBtnHeader);
        block.append(header, compact, content);
        recordArea.append(block);

        // compactãƒ“ãƒ¥ãƒ¼ã®åˆæœŸè¡¨ç¤ºã‚’æ›´æ–°
        updateCompactView(compact, entry);


        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š ---

        // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆä¿å­˜ãƒœã‚¿ãƒ³ã‚’å«ã‚€å…¨ä½“ï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã§æŠ˜ã‚ŠãŸãŸã¿/å±•é–‹
        header.onclick = (e) => {
            // ä¿å­˜ãƒœã‚¿ãƒ³ä»¥å¤–ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã®ã¿æŠ˜ã‚ŠãŸãŸã¿/å±•é–‹
            if (e.target !== saveBtnHeader) {
                let currentEntry = allDayData[key] || JSON.parse(JSON.stringify(defaultEntry));
                currentEntry.folded = !currentEntry.folded;
                allDayData[key] = currentEntry; // allDayDataã‚’æ›´æ–°
                saveToLocalStorage(dateStr, key, currentEntry); // æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã‚’ä¿å­˜
                render(); // UIã‚’å†æç”»ã—ã¦æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã‚’åæ˜ 
            }
        };
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼å†…ã®ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè¤‡æ•°æ™‚é–“å¸¯ã®æŠ˜ã‚ŠãŸãŸã¿ï¼‰
        saveBtnHeader.onclick = (e) => {
            e.stopPropagation(); // ãƒ˜ãƒƒãƒ€ãƒ¼å…¨ä½“ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
            
            const dateStr = dp.value;
            const currentDayData = JSON.parse(localStorage.getItem(dateStr) || '{}');

            // å…¨ã¦ã®æ™‚é–“å¸¯ã‚’ãƒ«ãƒ¼ãƒ—ã—ã€å…¥åŠ›ãŒã‚ã‚‹ã‚‚ã®ã ã‘æŠ˜ã‚ŠãŸãŸã‚€
            for (let j = 0; j < 24; j++) {
                const hourKey = (j + 4) % 24;
                const timeKey = hourKey.toString().padStart(2, '0');
                
                let entryToUpdate = currentDayData[timeKey] || JSON.parse(JSON.stringify(defaultEntry));

                // entryToUpdateãŒåˆæœŸå€¤ã¨ç•°ãªã‚‹å ´åˆã¯æŠ˜ã‚ŠãŸãŸã‚€
                // ã€Œç¡çœ ã€ã®ã¿ã®å ´åˆã‚‚æŠ˜ã‚ŠãŸãŸã¿å¯¾è±¡ã¨ãªã‚‹ã‚ˆã†ã« isEntryDefault ã‚’ä¿®æ­£æ¸ˆã¿
                if (!isEntryDefault(entryToUpdate)) {
                    entryToUpdate.folded = true;
                    currentDayData[timeKey] = entryToUpdate;
                }
            }
            // allDayDataã‚‚æ›´æ–°
            allDayData = currentDayData;
            saveToLocalStorage(dateStr, null, null, allDayData.dailyNote); // æ›´æ–°ã•ã‚ŒãŸallDayDataã‚’ã¾ã¨ã‚ã¦ä¿å­˜
            render(); // UIã‚’å†æç”»ã—ã¦æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã¨æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ 
        };

        compact.style.display = entry.folded ? 'block' : 'none';
      }
    }

    /**
     * ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤ºã®HTMLã‚’æ›´æ–°ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
     * @param {HTMLElement} compactElement - compactè¡¨ç¤ºã®divè¦ç´ 
     * @param {object} entry - è©²å½“æ™‚é–“å¸¯ã®ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     */
    function updateCompactView(compactElement, entry) {
        compactElement.innerHTML = `
          <strong>ã‚„ã£ãŸã“ã¨:</strong> ${entry.activity.join(', ') || 'â€•'}<br>
          <strong>æ°—åˆ†:</strong> ${entry.activity.includes("ç¡çœ ") ? 'ç¡çœ ä¸­' : (entry.mood === '' ? 'â€•' : entry.mood)}ã€€<strong>ç–²åŠ´:</strong> ${entry.activity.includes("ç¡çœ ") ? '' : (entry.fatigue === '' ? 'â€•' : entry.fatigue)}<br>
          <strong>ãƒ¡ãƒ¢:</strong> ${entry.free || 'â€•'}
        `;
    }


    // --- ã‚¢ãƒ—ãƒªåˆæœŸåŒ–ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---

    // æ—¥ä»˜ãƒ”ãƒƒã‚«ãƒ¼ã®åˆæœŸå€¤ã‚’ä»Šæ—¥ã«è¨­å®š
    dp.value = new Date().toISOString().split('T')[0];
    // æ—¥ä»˜å¤‰æ›´æ™‚ã«renderé–¢æ•°ã‚’å‘¼ã³å‡ºã™
    dp.onchange = render;

    // Daily Noteé–¢é€£ã®å…¥åŠ›å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
    function saveDailyNoteChanges() {
        const dateStr = dp.value;
        const currentDailyNote = {
            alcohol: alcoholChk.checked,
            caffeine: caffeineChk.checked,
            intakeMemo: intakeMemo.value,
            memo: dailyMemo.value
        };
        // allDayDataã®dailyNoteã‚’æ›´æ–°ã—ã¦ã‹ã‚‰ä¿å­˜
        allDayData.dailyNote = currentDailyNote;
        saveToLocalStorage(dateStr, null, null, currentDailyNote); // Daily Noteã®å¤‰æ›´ã®ã¿ã‚’ä¿å­˜é–¢æ•°ã«æ¸¡ã™
    }

    // å„è¦ç´ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    alcoholChk.addEventListener('change', saveDailyNoteChanges);
    caffeineChk.addEventListener('change', saveDailyNoteChanges);
    intakeMemo.addEventListener('input', saveDailyNoteChanges);
    dailyMemo.addEventListener('input', saveDailyNoteChanges);
    // ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ¼ãƒˆã®ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    dailyNoteSaveBtn.addEventListener('click', () => {
        saveDailyNoteChanges();
        alert('ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼'); // ä¿å­˜ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    });

    // ã‚¢ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã«åˆå›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    render();
  </script>
</body>
</html>
