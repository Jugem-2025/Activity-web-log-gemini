<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é€±é–“æ´»å‹•å†…è¨³</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 1000px; /* é€±é–“è¡¨ç¤ºãªã®ã§å°‘ã—åºƒã‚ã« */
      margin: auto;
      background: #f5f6fa;
      color: #333;
      padding: 15px;
      box-sizing: border-box;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #4a90e2;
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    header h1 {
      font-size: 1.4em;
      margin: 0;
    }
    .top-icons a {
      margin-left: 10px;
      color: white;
      font-size: 1.4em;
      text-decoration: none;
      padding: 5px;
    }
    .week-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .week-navigation button {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.2s;
    }
    .week-navigation button:hover {
      background: #5a6268;
    }
    #weekDisplay {
      font-weight: bold;
    }

    /* é€±è¡¨ç¤ºãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #weeklyTableContainer {
      overflow-x: auto; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¯èƒ½ã«ã™ã‚‹ */
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      padding: 10px; /* ãƒ†ãƒ¼ãƒ–ãƒ«å†…å¤–ã«ä½™ç™½ */
    }
    #weeklyTable {
      width: 100%; /* ã‚³ãƒ³ãƒ†ãƒŠã„ã£ã±ã„ã«åºƒãŒã‚‹ */
      border-collapse: collapse; /* ã‚»ãƒ«ã®å¢ƒç•Œç·šã‚’çµåˆ */
      min-width: 700px; /* ã‚¹ãƒãƒ›ã§æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹ãŸã‚ã®æœ€å°å¹… */
    }
    #weeklyTable th, #weeklyTable td {
      border: 1px dotted #ccc; /* ç‚¹ç·šã«å¤‰æ›´ */
      padding: 4px 8px; /* ä¸Šä¸‹ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’4pxã« */
      text-align: left;
      vertical-align: top; /* ä¸Šæƒãˆ */
      font-size: 0.85em; /* æ–‡å­—ã‚’å°ã•ã‚ã« */
    }
    #weeklyTable th {
      background: #f8f9fa;
      font-weight: bold;
      white-space: nowrap; /* æ—¥ä»˜ãŒæ”¹è¡Œã•ã‚Œãªã„ã‚ˆã†ã« */
    }
    #weeklyTable td {
      background: white;
      line-height: 1.2; /* è¡Œé–“ã‚’èª¿æ•´ */
      position: relative; /* å­è¦ç´ ã®é…ç½®ç”¨ */
    }

    /* å„é …ç›®ã‚’æ¨ªã«ä¸¦ã¹ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .daily-entry-content {
        display: flex;
        align-items: flex-start; /* ç¸¦æ–¹å‘ã®é–‹å§‹ä½ç½®ã‚’æƒãˆã‚‹ */
        gap: 5px; /* è¦ç´ é–“ã®éš™é–“ */
        line-height: 1.1; /* è¡Œã®é«˜ã•ã‚’è©°ã‚ã‚‹ */
    }
    .daily-entry-content .activity {
        flex-shrink: 0; /* ç¸®ã¾ãªã„ */
        max-width: 60%; /* ã‚„ã£ãŸã“ã¨ã®æœ€å¤§å¹… */
        word-wrap: break-word; /* é•·ã„å˜èªã®æŠ˜ã‚Šè¿”ã— */
    }
    .daily-entry-content .mood-value,
    .daily-entry-content .fatigue-value {
        flex-shrink: 0; /* ç¸®ã¾ãªã„ */
        width: 15%; /* æ°—åˆ†ã¨ç–²åŠ´åº¦ã®å¹…ã‚’èª¿æ•´ (å…¨ä½“ã®13%ã®æ¯”ç‡ã«åˆã‚ã›ã‚‹) */
        text-align: right;
        font-weight: bold;
        color: #2c3e50;
    }
    /* è‡ªç”±è¨˜å…¥æ¬„ã¯æ”¹è¡Œã—ã¦ä¸‹éƒ¨ã«è¡¨ç¤º */
    .daily-entry-content .free-text {
        position: absolute; /* è¦ªtdåŸºæº–ã§çµ¶å¯¾é…ç½® */
        bottom: 4px; /* ä¸‹ã‹ã‚‰ã®ä½ç½® */
        left: 8px; /* å·¦ã‹ã‚‰ã®ä½ç½® */
        right: 8px; /* å³ã‹ã‚‰ã®ä½ç½® */
        font-size: 0.75em;
        color: #777;
        line-height: 1.1;
        max-height: 2.2em; /* 2è¡Œç¨‹åº¦ã«åˆ¶é™ */
        overflow: hidden; /* ã¯ã¿å‡ºãŸã‚‰éš ã™ */
        text-overflow: ellipsis; /* ã¯ã¿å‡ºãŸãƒ†ã‚­ã‚¹ãƒˆã‚’...ã§è¡¨ç¤º */
        white-space: normal; /* æŠ˜ã‚Šè¿”ã—ã‚’è¨±å¯ */
    }

    .daily-summary {
      font-size: 0.8em;
      color: #666;
      margin-top: 3px; /* ä¸Šãƒãƒ¼ã‚¸ãƒ³ã‚’æ¸›ã‚‰ã™ */
      padding-top: 3px; /* ä¸Šãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¸›ã‚‰ã™ */
      border-top: 1px dashed #eee;
    }
    .daily-summary div { /* divã«å¤‰æ›´ */
        margin: 0;
        padding: 0;
        line-height: 1.1;
    }
    /* ç¡çœ ä¸­ã®è¡¨ç¤ºã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .sleep-entry-circle {
        display: inline-block;
        width: 1em;
        height: 1em;
        border: 1px solid black;
        border-radius: 50%;
        text-align: center;
        line-height: 1em;
        font-size: 0.8em;
        margin-left: 3px;
        vertical-align: middle;
    }

    /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« (æ¨ªé•·A4ã‚µã‚¤ã‚ºèª¿æ•´) */
    @media print {
      body {
        margin: 0 !important;
        /* A4æ¨ªé•·å¹… (297mm) ã¨é«˜ã• (210mm) ã‚’åŸºæº–ã«ã€ä½™ç™½ã‚’è¨ˆç®— */
        /* å·¦ã®ä½™ç™½3%: 297mm * 0.03 = 8.91mm */
        /* å³ã®ä½™ç™½2%: 297mm * 0.02 = 5.94mm */
        const paddingTopBottomMm = 4; // ä»®ã§4mm (è¦‹ãŸç›®ã«å¿œã˜ã¦èª¿æ•´)
        padding: 4mm 5.94mm 4mm 8.91mm !important; /* ä¸Šä¸‹å·¦å³ã®padding */
        max-width: none !important;
        width: 297mm !important; /* A4æ¨ªé•·å¹… */
        height: 210mm !important; /* A4æ¨ªé•·é«˜ã• */
        overflow: hidden !important;
        display: block !important; /* html2canvasã§éš ã‚Œãªã„ã‚ˆã†ã« */
        box-sizing: border-box !important;
        background-color: white !important; /* èƒŒæ™¯ã‚’ç™½ã« */
      }
      header, .week-navigation, .top-icons { /* å°åˆ·æ™‚ã«éè¡¨ç¤ºã«ã™ã‚‹è¦ç´  */
        display: none !important;
      }
      #weeklyTableContainer {
        border: none !important;
        box-shadow: none !important;
        padding: 0 !important;
        /* bodyã®paddingã‚’é™¤ã„ãŸæ®‹ã‚Šã®å¹…ãƒ»é«˜ã• */
        width: 100% !important; 
        height: 100% !important; 
        display: block !important; /* table-containerã‚’ãƒ–ãƒ­ãƒƒã‚¯è¦ç´ ã« */
        overflow: visible !important; /* å°åˆ·æ™‚ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸è¦ */
        box-sizing: border-box !important;
      }
      #weeklyTable {
        width: 100% !important; /* ã‚³ãƒ³ãƒ†ãƒŠã„ã£ã±ã„ã«åºƒãŒã‚‹ */
        height: 100% !important;
        border-collapse: collapse !important; /* ã‚»ãƒ«ã®å¢ƒç•Œç·šã‚’çµåˆ */
        table-layout: fixed !important; /* ã‚«ãƒ©ãƒ å¹…ã‚’å›ºå®š */
        font-size: 0.5em !important; /* å°åˆ·æ™‚ã«ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ã•ã‚‰ã«å°ã•ãèª¿æ•´ */
      }

      /* åˆ—å¹…ã®èª¿æ•´ */
      #weeklyTable thead tr th:first-child,
      #weeklyTable tbody tr td:first-child {
        width: 4% !important; /* 'æ™‚é–“' åˆ— 4% */
        min-width: 0 !important;
      }
      #weeklyTable thead tr th:not(:first-child),
      #weeklyTable tbody tr td:not(:first-child) {
        width: calc(96% / 7) !important; /* æ®‹ã‚Šã®96%ã‚’7æ—¥ã§å‡ç­‰ã«åˆ†å‰² */
        min-width: 0 !important;
      }

      /* è¡Œé«˜ã®èª¿æ•´ */
      #weeklyTable thead tr {
        height: 3% !important; /* æ™‚é–“ã‚„æ—¥ä»˜ã®è¡¨ç¤ºã®è¡Œ 3% */
      }
      #weeklyTable tbody tr {
        height: calc(97% / 25) !important; /* å„æ™‚é–“å¸¯ã®è¡Œ + å‚™è€ƒè¡Œã§åˆè¨ˆ25è¡Œ */
      }

      #weeklyTable th, #weeklyTable td {
        border: 1px dotted #ddd !important; /* å°åˆ·æ™‚ã‚‚ç‚¹ç·šã« */
        padding: 0.5mm 1mm !important; /* å°åˆ·æ™‚ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ï¼ˆãƒŸãƒªãƒ¡ãƒ¼ãƒˆãƒ«å˜ä½ï¼‰ */
        vertical-align: top !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
      }
      /* å°åˆ·æ™‚ã®ã‚»ãƒ«å†…è¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
      .daily-entry-content {
          gap: 2px !important; /* å°åˆ·æ™‚ã«ã‚ˆã‚Šè¦ç´ é–“ã®éš™é–“ã‚’è©°ã‚ã‚‹ */
          line-height: 1 !important; /* å°åˆ·æ™‚ã«ã‚ˆã‚Šè¡Œé–“ã‚’è©°ã‚ã‚‹ */
      }
      .daily-entry-content .activity {
          max-width: 65% !important; /* å°åˆ·æ™‚èª¿æ•´ */
          font-size: 0.9em !important;
      }
      .daily-entry-content .mood-value,
      .daily-entry-content .fatigue-value {
          width: 15% !important; /* å°åˆ·æ™‚èª¿æ•´ */
          font-size: 0.9em !important;
      }
      .daily-entry-content .free-text {
          font-size: 0.6em !important; /* å°åˆ·æ™‚èª¿æ•´ */
          bottom: 0.5mm !important; /* ä¸‹ã‹ã‚‰ã®ä½ç½®ã‚’èª¿æ•´ */
          left: 1mm !important; /* å·¦ã‹ã‚‰ã®ä½ç½®ã‚’èª¿æ•´ */
          right: 1mm !important; /* å³ã‹ã‚‰ã®ä½ç½®ã‚’èª¿æ•´ */
          max-height: 1.8em !important; /* å°åˆ·æ™‚ã®è¡Œåˆ¶é™ */
      }
      .daily-summary {
          margin-top: 0.5mm !important;
          padding-top: 0.5mm !important;
          border-top: 1px dashed #ddd !important;
          font-size: 0.8em !important; /* æ—¥ãƒ¡ãƒ¢ã®æ–‡å­—ã‚µã‚¤ã‚ºèª¿æ•´ */
      }
      .daily-summary div {
          font-size: 1em !important; /* è¦ªè¦ç´ ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã«ä¹—ç®—ã•ã‚Œã‚‹ã‚ˆã†ã« */
      }
      .sleep-entry-circle {
          border: 0.5px solid black !important; /* å°åˆ·æ™‚ã‚‚ç·š */
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>é€±é–“è¡¨ç¤º</h1>
    <div class="top-icons">
      <a href="index.html" title="æ´»å‹•è¨˜éŒ²">âœï¸</a>
      <a href="#" id="saveImageBtn" title="ç”»åƒã‚’ä¿å­˜">ğŸ“·</a>
    </div>
  </header>

  <div class="week-navigation">
    <button id="prevWeekBtn">â† å‰ã®é€±</button>
    <span id="weekDisplay"></span>
    <button id="nextWeekBtn">æ¬¡ã®é€± â†’</button>
  </div>

  <div id="weeklyTableContainer">
    <table id="weeklyTable">
      <thead>
        <tr id="dateRow">
          <th>æ™‚é–“</th>
        </tr>
      </thead>
      <tbody id="weeklyTableBody">
        </tbody>
    </table>
  </div>

  <script>
    const daysOfWeek = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
    const weeklyTableBody = document.getElementById('weeklyTableBody');
    const dateRow = document.getElementById('dateRow');
    const weekDisplay = document.getElementById('weekDisplay');
    const prevWeekBtn = document.getElementById('prevWeekBtn');
    const nextWeekBtn = document.getElementById('nextWeekBtn');
    const saveImageBtn = document.getElementById('saveImageBtn');

    let currentMonday = getMonday(new Date()); // ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹é€±ã®æœˆæ›œæ—¥

    // æŒ‡å®šã•ã‚ŒãŸæ—¥ä»˜ã®é€±ã®æœˆæ›œæ—¥ã‚’å–å¾—ã™ã‚‹é–¢æ•° (UTCåŸºæº–)
    function getMonday(date) {
        const d = new Date(date);
        // UTCã®æ›œæ—¥ã‚’å–å¾— (0=æ—¥æ›œ, 1=æœˆæ›œ...)
        const day = d.getUTCDay();
        // UTCã®æ—¥ä»˜ã‚’æœˆæ›œæ—¥ã«èª¿æ•´
        // æ—¥æ›œ(0)ã®å ´åˆã¯6æ—¥å‰ (å‰ã®é€±ã®æœˆæ›œæ—¥)
        // æœˆæ›œ(1)ã®å ´åˆã¯0æ—¥å‰
        // ç«æ›œ(2)ã®å ´åˆã¯1æ—¥å‰ ...
        const diff = d.getUTCDate() - day + (day === 0 ? -6 : 1);
        d.setUTCDate(diff);
        d.setUTCHours(0, 0, 0, 0); // æ™‚é–“ã‚’ãƒªã‚»ãƒƒãƒˆ (UTC)
        return d;
    }

    // æ—¥ä»˜ã‚’ "MM/DD(æ›œæ—¥)" å½¢å¼ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã§è¡¨ç¤º)
    function formatDate(date) {
      // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã§è§£é‡ˆã—ç›´ã™
      const localDate = new Date(date.getFullYear(), date.getMonth(), date.getDate()); 
      const month = (localDate.getMonth() + 1).toString().padStart(2, '0');
      const day = localDate.getDate().toString().padStart(2, '0');
      const dayOfWeek = daysOfWeek[localDate.getDay()]; // ãƒ­ãƒ¼ã‚«ãƒ«æ›œæ—¥
      return `${month}/${day}(${dayOfWeek})`;
    }

    // é€±ã®è¡¨ç¤ºç¯„å›²ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateWeekDisplay() {
      const sunday = new Date(currentMonday);
      sunday.setUTCDate(currentMonday.getUTCDate() + 6); // UTCã§6æ—¥åŠ ç®—
      weekDisplay.textContent = `${formatDate(currentMonday)} - ${formatDate(sunday)}`;
    }

    // é€±è¡¨ç¤ºãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
    function renderWeeklyTable() {
      dateRow.innerHTML = '<th>æ™‚é–“</th>'; // æ™‚é–“åˆ—ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’åˆæœŸåŒ–
      weeklyTableBody.innerHTML = ''; // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœãƒ‡ã‚£ã‚’ã‚¯ãƒªã‚¢

      const datesInWeek = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(currentMonday);
        date.setUTCDate(currentMonday.getUTCDate() + i); // UTCã§æ—¥ä»˜ã‚’é€²ã‚ã‚‹
        datesInWeek.push(date);

        const th = document.createElement('th');
        th.textContent = formatDate(date);
        dateRow.appendChild(th);
      }

      // å„æ™‚é–“å¸¯ã®è¡Œã‚’ç”Ÿæˆ (4:00 ã‹ã‚‰ç¿Œæ—¥ã®3:00 ã¾ã§)
      for (let i = 0; i < 24; i++) {
        const hour = (i + 4) % 24;
        const timeKey = hour.toString().padStart(2, '0');
        
        const tr = document.createElement('tr');
        const timeCell = document.createElement('td');
        timeCell.textContent = `${timeKey}:00`;
        tr.appendChild(timeCell);

        datesInWeek.forEach(date => {
          const td = document.createElement('td');
          const dateStr = date.toISOString().split('T')[0];
          const dailyData = JSON.parse(localStorage.getItem(dateStr) || '{}');
          const entry = dailyData[timeKey];

          const contentDiv = document.createElement('div');
          contentDiv.className = 'daily-entry-content';

          // ã‚„ã£ãŸã“ã¨
          const activitySpan = document.createElement('span');
          activitySpan.className = 'activity';
          if (entry && entry.activity && entry.activity.length > 0) {
              activitySpan.textContent = entry.activity.join(', ');
              if (entry.activity.includes("å°±å¯") || entry.activity.includes("ç¡çœ ")) {
                  const circleSpan = document.createElement('span');
                  circleSpan.className = 'sleep-entry-circle';
                  circleSpan.textContent = 'è–¬'; // è–¬ã®æ–‡å­—
                  activitySpan.appendChild(circleSpan);
              }
          }
          contentDiv.appendChild(activitySpan);

          // æ°—åˆ† (æ•°å€¤ã®ã¿)
          const moodSpan = document.createElement('span');
          moodSpan.className = 'mood-value';
          if (entry && (entry.mood || entry.mood === 0)) { // 0ã‚‚è¡¨ç¤º
              moodSpan.textContent = entry.mood;
          }
          contentDiv.appendChild(moodSpan);

          // ç–²åŠ´åº¦ (æ•°å€¤ã®ã¿)
          const fatigueSpan = document.createElement('span');
          fatigueSpan.className = 'fatigue-value';
          if (entry && (entry.fatigue || entry.fatigue === 0)) { // 0ã‚‚è¡¨ç¤º
              fatigueSpan.textContent = entry.fatigue;
          }
          contentDiv.appendChild(fatigueSpan);

          // è‡ªç”±è¨˜å…¥æ¬„ (çµ¶å¯¾é…ç½®ã§ä¸‹éƒ¨ã«è¡¨ç¤º)
          if (entry && entry.free) {
              const freeTextDiv = document.createElement('div');
              freeTextDiv.className = 'free-text';
              freeTextDiv.textContent = `ãƒ¡ãƒ¢: ${entry.free}`;
              td.appendChild(freeTextDiv); // tdç›´ä¸‹ã«è¿½åŠ 
          }
          
          td.appendChild(contentDiv); // ä¸»ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’tdã«è¿½åŠ 
          tr.appendChild(td);
        });
        weeklyTableBody.appendChild(tr);
      }

      // ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ¼ãƒˆã®ã‚µãƒãƒªãƒ¼è¡Œã‚’ç”Ÿæˆ
      const dailyNoteTr = document.createElement('tr');
      const dailyNoteHeader = document.createElement('th');
      dailyNoteHeader.textContent = 'å‚™è€ƒ'; // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã€Œå‚™è€ƒã€ã«å¤‰æ›´
      dailyNoteTr.appendChild(dailyNoteHeader);

      datesInWeek.forEach(date => {
        const td = document.createElement('td');
        const dateStr = date.toISOString().split('T')[0];
        const dailyData = JSON.parse(localStorage.getItem(dateStr) || '{}');
        const dailyNote = dailyData.dailyNote;

        if (dailyNote && (dailyNote.alcohol || dailyNote.caffeine || dailyNote.intakeMemo || dailyNote.memo)) {
          const summaryDiv = document.createElement('div');
          summaryDiv.className = 'daily-summary'; 

          if (dailyNote.alcohol) {
              const div = document.createElement('div');
              div.textContent = 'ãƒ»ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ‘‚å–';
              summaryDiv.appendChild(div);
          }
          if (dailyNote.caffeine) {
              const div = document.createElement('div');
              div.textContent = 'ãƒ»ã‚«ãƒ•ã‚§ã‚¤ãƒ³æ‘‚å–';
              summaryDiv.appendChild(div);
          }
          if (dailyNote.intakeMemo) {
              const div = document.createElement('div');
              div.textContent = `ãƒ»æ‘‚å–çŠ¶æ³: ${dailyNote.intakeMemo}`;
              summaryDiv.appendChild(div);
          }
          if (dailyNote.memo) {
              const div = document.createElement('div');
              div.textContent = `ãƒ»æ—¥ãƒ¡ãƒ¢: ${dailyNote.memo}`;
              summaryDiv.appendChild(div);
          }
          td.appendChild(summaryDiv);
        }
        // æœªè¨˜å…¥ã®å ´åˆã¯ç©ºã®ã¾ã¾ (ä½•ã‚‚è¿½åŠ ã—ãªã„)
        dailyNoteTr.appendChild(td);
      });
      weeklyTableBody.appendChild(dailyNoteTr); // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœãƒ‡ã‚£ã®æœ€å¾Œã«è¿½åŠ 

      updateWeekDisplay();
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    prevWeekBtn.addEventListener('click', () => {
      currentMonday.setUTCDate(currentMonday.getUTCDate() - 7); // UTCã§7æ—¥æ¸›ç®—
      renderWeeklyTable();
    });

    nextWeekBtn.addEventListener('click', () => {
      currentMonday.setUTCDate(currentMonday.getUTCDate() + 7); // UTCã§7æ—¥åŠ ç®—
      renderWeeklyTable();
    });

    // ç”»åƒä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    saveImageBtn.addEventListener('click', async (e) => {
        e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒªãƒ³ã‚¯å‹•ä½œã‚’é˜²æ­¢

        const element = document.body; // bodyå…¨ä½“ã‚’å¯¾è±¡

        // å°åˆ·ç”¨CSSã‚’ä¸€æ™‚çš„ã«é©ç”¨
        const printStyle = document.createElement('style');
        printStyle.id = 'print-style-for-capture'; // å¾Œã§å‰Šé™¤ã™ã‚‹ãŸã‚ã«IDã‚’è¨­å®š

        // A4ã‚µã‚¤ã‚ºï¼ˆæ¨ªé•·ï¼‰ã®ãƒŸãƒªãƒ¡ãƒ¼ãƒˆãƒ«å€¤
        const a4WidthMm = 297;
        const a4HeightMm = 210;

        // bodyã®paddingã‚’è¨ˆç®—ï¼ˆA4ã®æ¯”ç‡ã‹ã‚‰ï¼‰
        // å·¦ã®ä½™ç™½3%: 297mm * 0.03 = 8.91mm
        // å³ã®ä½™ç™½2%: 297mm * 0.02 = 5.94mm
        const paddingLeftMm = a4WidthMm * 0.03; 
        const paddingRightMm = a4WidthMm * 0.02;
        // ä¸Šä¸‹ã®ä½™ç™½ã¯ä»®ã§è¨­å®šã€‚å¿…è¦ã«å¿œã˜ã¦èª¿æ•´
        const paddingTopBottomMm = 4; // ä»®ã§4mm

        printStyle.innerHTML = `
            body {
                margin: 0 !important;
                padding: ${paddingTopBottomMm}mm ${paddingRightMm}mm ${paddingTopBottomMm}mm ${paddingLeftMm}mm !important;
                max-width: none !important;
                width: ${a4WidthMm}mm !important; /* A4æ¨ªé•·å¹… */
                height: ${a4HeightMm}mm !important; /* A4æ¨ªé•·é«˜ã• */
                overflow: hidden !important;
                display: block !important;
                box-sizing: border-box !important;
                background-color: white !important; /* èƒŒæ™¯ã‚’ç™½ã« */
            }
            header, .week-navigation, .top-icons {
                display: none !important;
            }
            #weeklyTableContainer {
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                width: 100% !important; 
                height: 100% !important; 
                display: block !important;
                overflow: visible !important;
                box-sizing: border-box !important;
            }
            #weeklyTable {
                width: 100% !important; /* ã‚³ãƒ³ãƒ†ãƒŠã„ã£ã±ã„ã«åºƒãŒã‚‹ */
                height: 100% !important;
                border-collapse: collapse !important; /* ã‚»ãƒ«ã®å¢ƒç•Œç·šã‚’çµåˆ */
                table-layout: fixed !important; /* ã‚«ãƒ©ãƒ å¹…ã‚’å›ºå®š */
                font-size: 0.5em !important; /* å°åˆ·æ™‚ã«ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ã•ã‚‰ã«å°ã•ãèª¿æ•´ */
            }

            /* åˆ—å¹…ã®èª¿æ•´ */
            #weeklyTable thead tr th:first-child,
            #weeklyTable tbody tr td:first-child {
                width: 4% !important; /* 'æ™‚é–“' åˆ— 4% */
                min-width: 0 !important;
            }
            #weeklyTable thead tr th:not(:first-child),
            #weeklyTable tbody tr td:not(:first-child) {
                width: calc(96% / 7) !important; /* æ®‹ã‚Šã®96%ã‚’7æ—¥ã§å‡ç­‰ã«åˆ†å‰² */
                min-width: 0 !important;
            }

            /* è¡Œé«˜ã®èª¿æ•´ */
            #weeklyTable thead tr {
                height: 3% !important; /* æ™‚é–“ã‚„æ—¥ä»˜ã®è¡¨ç¤ºã®è¡Œ 3% */
            }
            #weeklyTable tbody tr {
                height: calc(97% / 25) !important; /* å„æ™‚é–“å¸¯ã®è¡Œ + å‚™è€ƒè¡Œã§åˆè¨ˆ25è¡Œ */
            }

            #weeklyTable th, #weeklyTable td {
                border: 1px dotted #ddd !important; /* å°åˆ·æ™‚ã‚‚ç‚¹ç·šã« */
                padding: 0.5mm 1mm !important; /* å°åˆ·æ™‚ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ï¼ˆãƒŸãƒªãƒ¡ãƒ¼ãƒˆãƒ«å˜ä½ï¼‰ */
                vertical-align: top !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                position: relative !important; /* free-textã®absoluteé…ç½®ç”¨ */
            }
            /* å°åˆ·æ™‚ã®ã‚»ãƒ«å†…è¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
            .daily-entry-content {
                display: flex !important;
                align-items: flex-start !important;
                gap: 1mm !important; /* å°åˆ·æ™‚ã«ã‚ˆã‚Šè¦ç´ é–“ã®éš™é–“ã‚’è©°ã‚ã‚‹ */
                line-height: 1 !important; /* å°åˆ·æ™‚ã«ã‚ˆã‚Šè¡Œé–“ã‚’è©°ã‚ã‚‹ */
                font-size: 0.9em !important;
            }
            .daily-entry-content .activity {
                flex-shrink: 0 !important;
                max-width: 60% !important; /* å°åˆ·æ™‚èª¿æ•´ */
            }
            .daily-entry-content .mood-value,
            .daily-entry-content .fatigue-value {
                flex-shrink: 0 !important;
                width: 15% !important; /* å°åˆ·æ™‚èª¿æ•´ */
                text-align: right !important;
                font-weight: bold !important;
                color: #2c3e50 !important;
            }
            .daily-entry-content .free-text {
                position: absolute !important;
                bottom: 0.5mm !important;
                left: 1mm !important;
                right: 1mm !important;
                font-size: 0.6em !important;
                color: #777 !important;
                line-height: 1.1 !important;
                max-height: 1.8em !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                white-space: normal !important;
            }
            .daily-summary {
                margin-top: 0.5mm !important;
                padding-top: 0.5mm !important;
                border-top: 1px dashed #ddd !important;
                font-size: 0.8em !important;
            }
            .daily-summary div {
                font-size: 1em !important;
            }
            .sleep-entry-circle {
                border: 0.5px solid black !important;
            }
        `;
        document.head.appendChild(printStyle);

        // html2canvasã§è¦ç´ ã‚’ç”»åƒåŒ–
        const canvas = await html2canvas(element, {
            scale: 2, // é«˜è§£åƒåº¦ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            useCORS: true,
            windowWidth: element.scrollWidth, 
            windowHeight: element.scrollHeight,
            x: 0,
            y: 0,
            width: element.offsetWidth,
            height: element.offsetHeight,
        });

        // A4ã‚µã‚¤ã‚ºï¼ˆæ¨ªé•·ï¼‰ã®ãƒ”ã‚¯ã‚»ãƒ«å€¤ã‚’è¨ˆç®— (300dpiæƒ³å®š)
        const dpi = 300; 
        const mmPerInch = 25.4;
        const a4LandscapeWidthPx = (a4WidthMm / mmPerInch) * dpi; 
        const a4LandscapeHeightPx = (a4HeightMm / mmPerInch) * dpi; 

        const outputCanvas = document.createElement('canvas');
        outputCanvas.width = a4LandscapeWidthPx;
        outputCanvas.height = a4LandscapeHeightPx;
        const ctx = outputCanvas.getContext('2d');

        // èƒŒæ™¯ã‚’ç™½ã§å¡—ã‚Šã¤ã¶ã™ï¼ˆé€éã‚’é˜²ããŸã‚ï¼‰
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, outputCanvas.width, outputCanvas.height);

        // å…ƒã®canvasã®å†…å®¹ã‚’outputCanvasã«æç”»ï¼ˆA4ã‚µã‚¤ã‚ºã«ãƒ•ã‚£ãƒƒãƒˆã•ã›ã‚‹ï¼‰
        ctx.drawImage(canvas, 0, 0, a4LandscapeWidthPx, a4LandscapeHeightPx);

        // ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const imgData = outputCanvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = imgData;
        link.download = `weekly_report_${currentMonday.toISOString().split('T')[0]}_A4L.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // å°åˆ·ç”¨CSSã‚’å…ƒã«æˆ»ã™
        const styleToRemove = document.getElementById('print-style-for-capture');
        if (styleToRemove) {
            document.head.removeChild(styleToRemove);
        }

        // html2canvasé©ç”¨ä¸­ã«bodyã«ä»˜ä¸ã•ã‚ŒãŸå¯èƒ½æ€§ã®ã‚ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
        document.body.style.cssText = ''; 
    });

    // åˆæœŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    renderWeeklyTable();
  </script>
</body>
</html>
