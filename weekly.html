<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é€±é–“æ´»å‹•å†…è¨³</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 1000px;
      margin: auto;
      background: #f5f6fa;
      color: #333;
      padding: 15px;
      box-sizing: border-box;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #4a90e2;
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    header h1 {
      font-size: 1.4em;
      margin: 0;
    }
    .top-icons a {
      margin-left: 10px;
      color: white;
      font-size: 1.4em;
      text-decoration: none;
      padding: 5px;
    }
    .week-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .week-navigation button {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.2s;
    }
    .week-navigation button:hover {
      background: #5a6268;
    }
    #weekDisplay {
      font-weight: bold;
    }

    /* é€±è¡¨ç¤ºãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #weeklyTableContainer {
      overflow-x: auto;
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      padding: 10px;
      /* é€šå¸¸è¡¨ç¤ºæ™‚ã®A4æ¨ªå¹…ã‚’è¶…ãˆã‚‹ã‚µã‚¤ã‚ºã‚’è¨±å®¹ã™ã‚‹ãŸã‚min-widthã‚’è¨­å®š */
      min-width: 1200px;
    }
    #weeklyTable {
      width: 100%;
      border-collapse: collapse;
    }
    #weeklyTable th, #weeklyTable td {
      border: 1px solid #ccc;
      padding: 4px 8px;
      text-align: left;
      vertical-align: top;
      font-size: 0.85em;
      box-sizing: border-box;
    }
    #weeklyTable th {
      background: #f8f9fa;
      font-weight: bold;
      white-space: nowrap;
      text-align: center;
    }
    #weeklyTable td {
      background: white;
      line-height: 1.2;
      white-space: normal;
      word-break: break-word;
    }
    #weeklyTable td.time-cell {
      text-align: center;
      font-weight: bold;
    }
    #weeklyTable .activity-content {
        margin: 0;
        padding: 0;
    }
    #weeklyTable .mood-value, #weeklyTable .fatigue-value {
        text-align: center;
        white-space: nowrap;
    }
    #weeklyTable .memo-content {
        font-size: 0.8em;
        color: #555;
        margin-top: 5px;
        border-top: 1px dashed #eee;
        padding-top: 5px;
    }

    .daily-summary {
      font-size: 0.8em;
      color: #666;
      border-top: 1px dashed #eee;
    }
    .daily-summary p {
        margin: 0;
        padding: 0;
    }

    /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« (.printable-area ã‚¯ãƒ©ã‚¹ãŒ #weeklyTableContainer ã«ä»˜ä¸ã•ã‚ŒãŸã¨ãã«é©ç”¨) */
    /* bodyã¯å¤‰æ›´ã—ãªã„ (ç”»åƒå‡ºåŠ›ã§ã¯html2canvasãŒå¯¾è±¡è¦ç´ ã®ã¿ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£ã™ã‚‹ãŸã‚) */
    .printable-area {
      /* A4æ¨ªé•·ã‚µã‚¤ã‚º (297mm x 210mm) */
      width: 297mm !important;
      height: 210mm !important;
      /* ä¸Šä¸‹1%, å·¦å³2-3% ã®ä½™ç™½ã‚’A4ã‚µã‚¤ã‚ºåŸºæº–ã§è¨ˆç®—ã—ã¦ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã¨ã—ã¦é©ç”¨ */
      /* å·¦å³ã¯å·¦3%, å³2% */
      padding: calc(210mm * 0.01) calc(297mm * 0.02) calc(210mm * 0.01) calc(297mm * 0.03) !important;
      margin: 0 !important; /* ä¸­å¤®å¯„ã›è§£é™¤ */
      border: none !important; /* é€šå¸¸æ™‚ã®ãƒœãƒ¼ãƒ€ãƒ¼ã‚’å‰Šé™¤ */
      box-shadow: none !important; /* é€šå¸¸æ™‚ã®å½±ã‚’å‰Šé™¤ */
      background: white !important; /* èƒŒæ™¯ã‚’ç™½ã« */
      overflow: visible !important; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã€å†…å®¹å…¨ä½“ã‚’è¡¨ç¤º */
      min-width: unset !important; /* é€šå¸¸æ™‚ã®min-widthã‚’è§£é™¤ */
      font-size: 0.3em !important; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ç¸®å° - ã“ã‚ŒãŒãƒ†ã‚­ã‚¹ãƒˆã®è‡ªå‹•èª¿æ•´ã®ä¸»è»¸ */
      box-sizing: border-box !important; /* paddingã‚’width/heightã«å«ã‚ã‚‹ */
    }
    .printable-area #weeklyTable {
      width: 100% !important;
      height: 100% !important;
      border-collapse: collapse !important;
      table-layout: fixed !important; /* â˜…é‡è¦: ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å›ºå®š */
    }

    /* åˆ—å¹…ã®èª¿æ•´ */
    .printable-area #weeklyTable thead tr th:first-child,
    .printable-area #weeklyTable tbody tr td.time-cell {
      width: 4% !important; /* 'æ™‚é–“' åˆ— 4% */
      min-width: 0 !important;
    }

    /* å„æ—¥ä»˜ãƒ–ãƒ­ãƒƒã‚¯ (7æ—¥åˆ†) ã¯æ®‹ã‚Šã® 96% ã‚’å ã‚ã‚‹ */
    /* å„æ—¥ä»˜ãƒ–ãƒ­ãƒƒã‚¯ã®å¹…ã¯ (96% / 7) */
    /* æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼ (colspan=3) ã®å¹…ã‚’ã€ä¸‹ã®3åˆ—ã®åˆè¨ˆå¹…ã¨åŒã˜ã«ã™ã‚‹ */
    .printable-area #weeklyTable thead tr #dateRow th:nth-child(n+2) { /* 2ç•ªç›®ä»¥é™ã®æ—¥ä»˜thï¼ˆæ™‚é–“åˆ—ã®æ¬¡ã‹ã‚‰ï¼‰ */
        width: calc(96% / 7) !important;
    }

    /* ã‚µãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ«ã®å¹…èª¿æ•´: ã‚„ã£ãŸã“ã¨:70, æ°—åˆ†:15, ç–²åŠ´åº¦:15 ã®æ¯”ç‡ */
    /* åˆè¨ˆ 70+15+15 = 100 */
    /* ã‚„ã£ãŸã“ã¨: å„æ—¥ä»˜ãƒ–ãƒ­ãƒƒã‚¯å¹…ã® 70/100 */
    .printable-area #weeklyTable thead tr #subHeaderRow th:nth-child(3n+1), /* 1ç•ªç›®ã®ã€Œã‚„ã£ãŸã“ã¨ã€ã€4ç•ªç›®ã®ã€Œã‚„ã£ãŸã“ã¨ã€... */
    .printable-area #weeklyTable tbody tr td.activity-col {
        width: calc((96% / 7) * (70 / 100)) !important; /* 70% */
        overflow: hidden !important;
        text-overflow: ellipsis !important; /* ã¯ã¿å‡ºãŸã‚‰... */
        white-space: normal !important; /* å¿…è¦ã«å¿œã˜ã¦æ”¹è¡Œã‚’è¨±å¯ */
    }
    /* æ°—åˆ†: å„æ—¥ä»˜ãƒ–ãƒ­ãƒƒã‚¯å¹…ã® 15/100 */
    .printable-area #weeklyTable thead tr #subHeaderRow th:nth-child(3n+2), /* 2ç•ªç›®ã®ã€Œæ°—åˆ†ã€ã€5ç•ªç›®ã®ã€Œæ°—åˆ†ã€... */
    .printable-area #weeklyTable tbody tr td.mood-col {
        width: calc((96% / 7) * (15 / 100)) !important; /* 15% */
        text-align: center !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important; /* æ”¹è¡Œã•ã›ãªã„ */
    }
    /* ç–²åŠ´åº¦: å„æ—¥ä»˜ãƒ–ãƒ­ãƒƒã‚¯å¹…ã® 15/100 */
    .printable-area #weeklyTable thead tr #subHeaderRow th:nth-child(3n+3), /* 3ç•ªç›®ã®ã€Œç–²åŠ´åº¦ã€ã€6ç•ªç›®ã®ã€Œç–²åŠ´åº¦ã€... */
    .printable-area #weeklyTable tbody tr td.fatigue-col {
        width: calc((96% / 7) * (15 / 100)) !important; /* 15% */
        text-align: center !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important; /* æ”¹è¡Œã•ã›ãªã„ */
    }

    /* è¡Œé«˜ã®èª¿æ•´ */
    .printable-area #weeklyTable thead #dateRow {
      height: 3% !important; /* æ—¥ä»˜ã¨æ›œæ—¥ã®è¡Œ */
    }
    .printable-area #weeklyTable thead #subHeaderRow {
      height: 3% !important; /* ã‚„ã£ãŸã“ã¨ã€æ°—åˆ†ã€ç–²åŠ´åº¦ã®è¡Œ */
    }
    /* æ®‹ã‚Šã®94%ã‚’24æ™‚é–“å¸¯(24è¡Œ) + å‚™è€ƒè¡Œ(1è¡Œ) = 25è¡Œã§åˆ†é… */
    .printable-area #weeklyTable tbody tr {
      height: calc(94% / 25) !important;
      min-height: 0;
    }
    /* å‚™è€ƒè¡Œã¯å†…å®¹ã«åˆã‚ã›ã¦é«˜ã•ã‚’èª¿æ•´ã—ã¤ã¤ã€æœ€ä½é™ã®é«˜ã•ã‚’ç¢ºä¿ã—ã€ç¸¦æ–¹å‘ä¸­å¤®æƒãˆ */
    .printable-area #weeklyTable tbody tr:last-child {
        height: auto !important;
        min-height: calc(94% / 25) !important;
        vertical-align: middle !important;
    }

    .printable-area #weeklyTable th, .printable-area #weeklyTable td {
      border: 1px solid black !important; /* ç”»åƒå‡ºåŠ›æ™‚ã®ç½«ç·šã‚’æ˜ç¢ºã« */
      padding: 0.5mm 0.8mm !important; /* å°åˆ·æ™‚ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
      vertical-align: top !important; /* ä¸Šéƒ¨ã«æƒãˆã‚‹ */
      word-wrap: break-word; /* é•·ã„å˜èªã®æŠ˜ã‚Šè¿”ã— */
      border-spacing: 0 !important; /* ç½«ç·šã®éš™é–“ã‚’ãªãã™ */
    }
    .printable-area #weeklyTable td.time-cell {
      padding: 1mm !important;
    }

    .printable-area #weeklyTable .memo-content {
        margin-top: 0.5mm !important;
        padding-top: 0.5mm !important;
        border-top: 1px solid black !important;
        font-size: 0.7em !important; /* è¦ªã‚ˆã‚Šã•ã‚‰ã«å°ã•ã */
    }
    .printable-area .daily-summary {
      margin-top: 1mm !important;
      padding-top: 1mm !important;
      border-top: 1px solid black !important;
      font-size: 0.7em !important; /* è¦ªã‚ˆã‚Šã•ã‚‰ã«å°ã•ã */
    }
    .printable-area .daily-summary p {
      font-size: 0.8em !important; /* ã•ã‚‰ã«å°‘ã—å°ã•ã */
      margin: 0.5mm 0 !important;
      line-height: 1.0 !important;
    }

    /* @media print ã¯ãã®ã¾ã¾æ®‹ã—ã¦ã€ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã‹ã‚‰ã®å°åˆ·ã«å½±éŸ¿ã‚’ä¸ãˆãªã„ã‚ˆã†ã«ã™ã‚‹ */
    @media print {
        body {
            /* å°åˆ·æ™‚ã«ã¯é€šå¸¸ãƒšãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¶­æŒã™ã‚‹ã‹ã€åˆ¥é€”èª¿æ•´ãŒå¿…è¦ */
            margin: 0;
            padding: 0;
            max-width: none;
            width: 100%;
            height: 100vh; /* ç”»é¢ã®é«˜ã•ã«åˆã‚ã›ã‚‹ */
            overflow: auto;
            background-color: white;
            font-size: 1em; /* é€šå¸¸ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã«æˆ»ã™ */
        }
        header, .week-navigation, .top-icons {
            display: none !important;
        }
        #weeklyTableContainer {
            border: none !important;
            box-shadow: none !important;
            /* å°åˆ·æ™‚ã®ã‚³ãƒ³ãƒ†ãƒŠã®ã‚µã‚¤ã‚ºã¯ã€bodyã®ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦è‡ªå‹•èª¿æ•´ã•ã‚Œã‚‹ */
            width: 297mm !important; /* A4æ¨ªå¹… */
            height: 210mm !important; /* A4ç¸¦å¹… */
            padding: calc(210mm * 0.01) calc(297mm * 0.02) calc(210mm * 0.01) calc(297mm * 0.03) !important;
            margin: 0 auto !important; /* å°åˆ·ãƒšãƒ¼ã‚¸ã§ä¸­å¤®ã«å¯„ã›ã‚‹å ´åˆ */
            overflow: visible !important;
            box-sizing: border-box !important;
            font-size: 0.3em !important; /* å°åˆ·æ™‚ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º */
        }
        #weeklyTable {
            width: 100% !important;
            height: 100% !important;
            border-collapse: collapse !important;
            table-layout: fixed !important;
        }
        /* åˆ—å¹…ã®èª¿æ•´ */
        #weeklyTable thead tr th:first-child,
        #weeklyTable tbody tr td.time-cell {
            width: 4% !important;
            min-width: 0 !important;
        }
        #weeklyTable thead tr #dateRow th:nth-child(n+2) {
            width: calc(96% / 7) !important;
        }
        #weeklyTable thead tr #subHeaderRow th:nth-child(3n+1),
        #weeklyTable tbody tr td.activity-col {
            width: calc((96% / 7) * (70 / 100)) !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: normal !important;
        }
        #weeklyTable thead tr #subHeaderRow th:nth-child(3n+2),
        #weeklyTable tbody tr td.mood-col {
            width: calc((96% / 7) * (15 / 100)) !important;
            text-align: center !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
        }
        #weeklyTable thead tr #subHeaderRow th:nth-child(3n+3),
        #weeklyTable tbody tr td.fatigue-col {
            width: calc((96% / 7) * (15 / 100)) !important;
            text-align: center !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
        }
        /* è¡Œé«˜ã®èª¿æ•´ */
        #weeklyTable thead #dateRow {
          height: 3% !important;
        }
        #weeklyTable thead #subHeaderRow {
          height: 3% !important;
        }
        #weeklyTable tbody tr {
          height: calc(94% / 25) !important;
          min-height: 0;
        }
        #weeklyTable tbody tr:last-child {
            height: auto !important;
            min-height: calc(94% / 25) !important;
            vertical-align: middle !important;
        }
        #weeklyTable th, #weeklyTable td {
          border: 1px solid black !important;
          padding: 0.5mm 0.8mm !important;
          vertical-align: top !important;
          word-wrap: break-word;
          border-spacing: 0 !important;
        }
        #weeklyTable td.time-cell {
          padding: 1mm !important;
        }
        #weeklyTable .memo-content {
            margin-top: 0.5mm !important;
            padding-top: 0.5mm !important;
            border-top: 1px solid black !important;
            font-size: 0.7em !important;
        }
        .daily-summary {
          margin-top: 1mm !important;
          padding-top: 1mm !important;
          border-top: 1px solid black !important;
          font-size: 0.7em !important;
        }
        .daily-summary p {
          font-size: 0.8em !important;
          margin: 0.5mm 0 !important;
          line-height: 1.0 !important;
        }
    }
  </style>
</head>
<body>
  <header>
    <h1>é€±é–“è¡¨ç¤º</h1>
    <div class="top-icons">
      <a href="index.html" title="æ´»å‹•è¨˜éŒ²">âœï¸</a>
      <a href="#" id="saveImageBtn" title="ç”»åƒã‚’ä¿å­˜">ğŸ“·</a>
    </div>
  </header>

  <div class="week-navigation">
    <button id="prevWeekBtn">â† å‰ã®é€±</button>
    <span id="weekDisplay"></span>
    <button id="nextWeekBtn">æ¬¡ã®é€± â†’</button>
  </div>

  <div id="weeklyTableContainer">
    <table id="weeklyTable">
      <thead>
        <tr id="dateRow">
          <th rowspan="2">æ™‚é–“</th>
        </tr>
        <tr id="subHeaderRow"></tr>
      </thead>
      <tbody id="weeklyTableBody">
        </tbody>
    </table>
  </div>

  <script>
    const daysOfWeek = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
    const weeklyTableBody = document.getElementById('weeklyTableBody');
    const dateRow = document.getElementById('dateRow');
    const subHeaderRow = document.getElementById('subHeaderRow');
    const weekDisplay = document.getElementById('weekDisplay');
    const prevWeekBtn = document.getElementById('prevWeekBtn');
    const nextWeekBtn = document.getElementById('nextWeekBtn');
    const saveImageBtn = document.getElementById('saveImageBtn');
    const weeklyTableContainer = document.getElementById('weeklyTableContainer'); // è¿½åŠ 

    let currentMonday = getMonday(new Date());

    function getMonday(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        d.setDate(diff);
        d.setHours(0, 0, 0, 0);
        return d;
    }

    function formatDate(date) {
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      const dayOfWeek = daysOfWeek[date.getDay()];
      return `${month}/${day}(${dayOfWeek})`;
    }

    function updateWeekDisplay() {
      const sunday = new Date(currentMonday);
      sunday.setDate(currentMonday.getDate() + 6);
      weekDisplay.textContent = `${formatDate(currentMonday)} - ${formatDate(sunday)}`;
    }

    function renderWeeklyTable() {
      dateRow.innerHTML = '<th rowspan="2">æ™‚é–“</th>';
      subHeaderRow.innerHTML = '';

      const datesInWeek = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(currentMonday);
        date.setDate(currentMonday.getDate() + i);
        datesInWeek.push(date);

        const thDate = document.createElement('th');
        thDate.textContent = formatDate(date);
        thDate.setAttribute('colspan', '3');
        dateRow.appendChild(thDate);

        const thActivity = document.createElement('th');
        thActivity.textContent = 'ã‚„ã£ãŸã“ã¨';
        subHeaderRow.appendChild(thActivity);

        const thMood = document.createElement('th');
        thMood.textContent = 'æ°—åˆ†';
        subHeaderRow.appendChild(thMood);

        const thFatigue = document.createElement('th');
        thFatigue.textContent = 'ç–²åŠ´åº¦';
        subHeaderRow.appendChild(thFatigue);
      }

      weeklyTableBody.innerHTML = '';

      // 4æ™‚ã‹ã‚‰å§‹ã¾ã‚Šç¿Œæœ3æ™‚ã¾ã§ã®24æ™‚é–“åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
      for (let i = 4; i < 28; i++) { // iã‚’4ã‹ã‚‰é–‹å§‹ã—ã€27ã¾ã§ï¼ˆ4, 5, ..., 23, 0, 1, 2, 3ï¼‰
        const hour = i % 24; // 0-23ã®ç¯„å›²ã«æ­£è¦åŒ–
        const timeKey = hour.toString().padStart(2, '0');

        const tr = document.createElement('tr');
        const timeCell = document.createElement('td');
        timeCell.textContent = `${timeKey}:00`;
        timeCell.classList.add('time-cell');
        tr.appendChild(timeCell);

        // å„æ—¥ä»˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        // ã“ã“ã§ã€ã‚‚ã—æ—¥ä»˜ãŒç¿Œæ—¥ã«ãªã‚‹æ™‚é–“å¸¯ (0æ™‚ï½3æ™‚) ã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ãªå ´åˆã¯ã€
        // dateStr ã‚’å–å¾—ã™ã‚‹éš›ã«æ—¥ä»˜ã‚’èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
        // ãŸã ã—ã€ç¾åœ¨ã®localStorageã®ã‚­ãƒ¼ã¯YYYY-MM-DDå½¢å¼ãªã®ã§ã€
        // ã“ã“ã§ãã‚Œã‚’è·¨ãã‚ˆã†ãªè¤‡é›‘ãªãƒ‡ãƒ¼ã‚¿å‚ç…§ã¯è¡Œã‚ãšã€
        // å˜ç´”ã«ãã®ã€Œè¡¨ç¤ºæ™‚é–“ã€ã¨ã—ã¦å¯¾å¿œã™ã‚‹æ™‚é–“å¸¯ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹æ–¹é‡ã¨ã—ã¾ã™ã€‚
        // (ä¾‹: 0æ™‚å°ã¯å‰æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã§ã¯ãªãã€ãã®æ—¥ã®0æ™‚å°ã®ãƒ‡ãƒ¼ã‚¿)
        datesInWeek.forEach(date => {
          let targetDate = new Date(date);
          // ã‚‚ã—è¡¨ç¤ºæ™‚é–“ãŒç¿Œæ—¥ã®ã‚‚ã®ï¼ˆ0æ™‚ã€1æ™‚ã€2æ™‚ã€3æ™‚ï¼‰ã§ã‚ã‚Œã°ã€
          // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹æ—¥ä»˜ã‚’å‰æ—¥ã«ã™ã‚‹èª¿æ•´ãŒå¿…è¦
          // ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹æ—¥ä»˜ã«ç´ã¥ãæ™‚é–“ã‚’ãã®ã¾ã¾å‚ç…§ã™ã‚‹æ–¹é‡
          // ã‚‚ã—æœ¬å½“ã«ç¿Œæ—¥0-3æ™‚ã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ãªã‚‰ã€ã“ã“ã‚’è¤‡é›‘ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€
          // ã€Œ4æ™‚å§‹ã¾ã‚Šã®é€±é–“è¡¨ç¤ºã€ã¯ã€é€šå¸¸ã¯ãã®æ—¥ã®4æ™‚ã€œç¿Œæ—¥ã®3æ™‚ã¾ã§ã‚’ãã®ã€Œæ—¥ã€ã¨ã—ã¦æ‰±ã†ãŸã‚ã€
          // ç¾åœ¨ã®å®Ÿè£…ã§å•é¡Œãªã„ã“ã¨ãŒå¤šã„ã§ã™ã€‚
          // ã‚‚ã—ã€Œå‰æ—¥ã®23æ™‚ã®æ¬¡ã¯å½“æ—¥ã®0æ™‚ã€ã¨ã„ã†å½¢ã§æ—¥ä»˜ã‚’ã¾ãŸããƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ãªå ´åˆã¯ã€
          // ã“ã®datesInWeek.forEachå†…ã® dateStr ã®è¨ˆç®—ã‚’å·¥å¤«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
          // ãŸã ã—ã€ã“ã‚Œã¯ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«ä¾å­˜ã™ã‚‹ãŸã‚ã€ç¾åœ¨ã®è³ªå•ã§ã¯ã“ã®ã¾ã¾ã¨ã—ã¾ã™ã€‚
          const dateStr = targetDate.getFullYear() + '-' +
                          (targetDate.getMonth() + 1).toString().padStart(2, '0') + '-' +
                          targetDate.getDate().toString().padStart(2, '0');
          const dailyData = JSON.parse(localStorage.getItem(dateStr) || '{}');
          const entry = dailyData?.[timeKey];

          const tdActivity = document.createElement('td');
          tdActivity.classList.add('activity-col');
          if (entry?.activity && entry.activity.length > 0) {
              const activityP = document.createElement('p');
              activityP.classList.add('activity-content');
              activityP.textContent = entry.activity.join(', ');
              tdActivity.appendChild(activityP);
          } else {
              tdActivity.textContent = '';
          }
          if (entry?.free) {
              const freeP = document.createElement('p');
              freeP.classList.add('memo-content');
              freeP.textContent = `ãƒ¡ãƒ¢: ${entry.free}`;
              tdActivity.appendChild(freeP);
          }
          tr.appendChild(tdActivity);

          const tdMood = document.createElement('td');
          tdMood.classList.add('mood-col');
          if (entry?.activity && entry.activity.includes("ç¡çœ ")) {
              tdMood.textContent = '';
          } else if (entry?.mood !== '' && entry?.mood !== null && entry?.mood !== undefined) {
              const moodP = document.createElement('p');
              moodP.classList.add('mood-value');
              moodP.textContent = entry.mood;
              tdMood.appendChild(moodP);
          } else {
              tdMood.textContent = '';
          }
          tr.appendChild(tdMood);

          const tdFatigue = document.createElement('td');
          tdFatigue.classList.add('fatigue-col');
          if (entry?.fatigue !== '' && entry?.fatigue !== null && entry?.fatigue !== undefined) {
              const fatigueP = document.createElement('p');
              fatigueP.classList.add('fatigue-value');
              fatigueP.textContent = entry.fatigue;
              tdFatigue.appendChild(fatigueP);
          } else if (entry?.activity && entry.activity.includes("ç¡çœ ")) {
              tdFatigue.textContent = '';
          }
          else {
              tdFatigue.textContent = '';
          }
          tr.appendChild(tdFatigue);
        });
        weeklyTableBody.appendChild(tr);
      }

      const dailyNoteTr = document.createElement('tr');
      const dailyNoteHeader = document.createElement('th');
      dailyNoteHeader.textContent = 'å‚™è€ƒ';
      dailyNoteTr.appendChild(dailyNoteHeader);

      datesInWeek.forEach(date => {
        const dateStr = date.getFullYear() + '-' +
                        (date.getMonth() + 1).toString().padStart(2, '0') + '-' +
                        date.getDate().toString().padStart(2, '0');
        const dailyData = JSON.parse(localStorage.getItem(dateStr) || '{}');
        const dailyNote = dailyData?.dailyNote;

        const tdMemo = document.createElement('td');
        tdMemo.setAttribute('colspan', '3');
        tdMemo.classList.add('daily-note-cell');

        if (dailyNote && (dailyNote.alcohol || dailyNote.caffeine || dailyNote.intakeMemo || dailyNote.memo)) {
          const summaryDiv = document.createElement('div');
          summaryDiv.className = 'daily-summary';
          let summaryText = '';
          if (dailyNote.alcohol) summaryText += '<p>ãƒ»ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ‘‚å–</p>';
          if (dailyNote.caffeine) summaryText += '<p>ãƒ»ã‚«ãƒ•ã‚§ã‚¤ãƒ³æ‘‚å–</p>';
          if (dailyNote.intakeMemo) summaryText += `<p>ãƒ»æ‘‚å–çŠ¶æ³: ${dailyNote.intakeMemo}</p>`;
          if (dailyNote.memo) summaryText += `<p>ãƒ»æ—¥ãƒ¡ãƒ¢: ${dailyNote.memo}</p>`;
          summaryDiv.innerHTML = summaryText;
          tdMemo.appendChild(summaryDiv);
        } else {
          tdMemo.textContent = '';
        }
        dailyNoteTr.appendChild(tdMemo);
      });
      weeklyTableBody.appendChild(dailyNoteTr);

      updateWeekDisplay();
    }

    prevWeekBtn.addEventListener('click', () => {
      currentMonday.setDate(currentMonday.getDate() - 7);
      renderWeeklyTable();
    });

    nextWeekBtn.addEventListener('click', () => {
      currentMonday.setDate(currentMonday.getDate() + 7);
      renderWeeklyTable();
    });

    saveImageBtn.addEventListener('click', async (e) => {
        e.preventDefault();

        // ã‚­ãƒ£ãƒ—ãƒãƒ£å¯¾è±¡ã‚’ #weeklyTableContainer ã«å¤‰æ›´
        const elementToCapture = weeklyTableContainer;

        // printable-area ã‚¯ãƒ©ã‚¹ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£å¯¾è±¡è¦ç´ ã«é©ç”¨
        elementToCapture.classList.add('printable-area');

        const startDate = formatDateForFilename(currentMonday);
        const endDate = formatDateForFilename(new Date(currentMonday.getFullYear(), currentMonday.getMonth(), currentMonday.getDate() + 6));

        // CSSã®é©ç”¨ãŒå®Œäº†ã™ã‚‹ã¾ã§ã‚ãšã‹ã«å¾…ã¤
        await new Promise(resolve => setTimeout(resolve, 100)); // 100mså¾…æ©Ÿã‚’æ¨å¥¨

        // html2canvasã§è¦ç´ ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
        // elementToCaptureã®ç¾åœ¨ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚µã‚¤ã‚ºãŒè‡ªå‹•çš„ã«ä½¿ç”¨ã•ã‚Œã‚‹
        const canvas = await html2canvas(elementToCapture, {
            scale: 3, // é«˜è§£åƒåº¦ã§ã‚­ãƒ£ãƒ—ãƒãƒ£ (300dpiç›¸å½“)
            useCORS: true,
        });

        // A4ã‚µã‚¤ã‚ºï¼ˆæ¨ªé•·ï¼‰ã®ãƒ”ã‚¯ã‚»ãƒ«å€¤ã‚’è¨ˆç®— (300dpiæƒ³å®š)
        const dpi = 300;
        const mmPerInch = 25.4;
        const a4WidthMm = 297;
        const a4HeightMm = 210;
        const a4LandscapeWidthPx = Math.floor((a4WidthMm / mmPerInch) * dpi);
        const a4LandscapeHeightPx = Math.floor((a4HeightMm / mmPerInch) * dpi);

        const outputCanvas = document.createElement('canvas');
        outputCanvas.width = a4LandscapeWidthPx;
        outputCanvas.height = a4LandscapeHeightPx;
        const ctx = outputCanvas.getContext('2d');

        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, outputCanvas.width, outputCanvas.height);

        // ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸç”»åƒã‚’A4ã‚µã‚¤ã‚ºã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»
        // printable-areaã®paddingã‚’è€ƒæ…®ã—ã¦æç”»é ˜åŸŸã‚’è¨ˆç®—
        // CSSã®padding: calc(210mm * 0.01) calc(297mm * 0.02) calc(210mm * 0.01) calc(297mm * 0.03) !important;
        // ä¸Šä¸‹ 1% -> 210mm * 0.01 = 2.1mm
        // å·¦ 3%, å³ 2% -> 297mm * 0.03 = 8.91mm (å·¦), 297mm * 0.02 = 5.94mm (å³)

        const paddingLeftPx = (297 * 0.03 / mmPerInch) * dpi; // 3%
        const paddingRightPx = (297 * 0.02 / mmPerInch) * dpi; // 2%
        const paddingTopPx = (210 * 0.01 / mmPerInch) * dpi; // 1%
        const paddingBottomPx = (210 * 0.01 / mmPerInch) * dpi; // 1%

        const drawableWidth = outputCanvas.width - paddingLeftPx - paddingRightPx;
        const drawableHeight = outputCanvas.height - paddingTopPx - paddingBottomPx;

        const canvasAspectRatio = canvas.width / canvas.height;
        const drawableAspectRatio = drawableWidth / drawableHeight;

        let drawWidth, drawHeight;
        let offsetX = paddingLeftPx;
        let offsetY = paddingTopPx;

        if (canvasAspectRatio > drawableAspectRatio) {
            // ã‚­ãƒ£ãƒ—ãƒãƒ£ç”»åƒã®æ–¹ãŒæ¨ªé•·ã®å ´åˆã€æç”»å¯èƒ½å¹…ã«åˆã‚ã›ã¦é«˜ã•ã‚’èª¿æ•´
            drawWidth = drawableWidth;
            drawHeight = drawableWidth / canvasAspectRatio;
            offsetY += (drawableHeight - drawHeight) / 2; // å‚ç›´æ–¹å‘ä¸­å¤®æƒãˆ
        } else {
            // ã‚­ãƒ£ãƒ—ãƒãƒ£ç”»åƒã®æ–¹ãŒç¸¦é•·ã®å ´åˆã€æç”»å¯èƒ½é«˜ã•ã«åˆã‚ã›ã¦å¹…ã‚’èª¿æ•´
            drawHeight = drawableHeight;
            drawWidth = drawableHeight * canvasAspectRatio;
            offsetX += (drawableWidth - drawWidth) / 2; // æ°´å¹³æ–¹å‘ä¸­å¤®æƒãˆ
        }

        ctx.drawImage(canvas, offsetX, offsetY, drawWidth, drawHeight);

        const imgData = outputCanvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = imgData;
        link.download = `weekly_report_${startDate}_to_${endDate}_A4L.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ã—ã¦å…ƒã®ã‚¹ã‚¿ã‚¤ãƒ«ã«æˆ»ã™
        elementToCapture.classList.remove('printable-area');
    });

    function formatDateForFilename(date) {
        return date.getFullYear() + '-' +
               (date.getMonth() + 1).toString().padStart(2, '0') + '-' +
               date.getDate().toString().padStart(2, '0');
    }

    renderWeeklyTable();
  </script>
</body>
</html>
