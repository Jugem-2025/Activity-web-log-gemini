<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é€±é–“è¡¨ç¤º</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 1000px; /* é€±é–“è¡¨ç¤ºãªã®ã§å°‘ã—åºƒã‚ã« */
      margin: auto;
      background: #f5f6fa;
      color: #333;
      padding: 15px;
      box-sizing: border-box;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #4a90e2;
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    header h1 {
      font-size: 1.4em;
      margin: 0;
    }
    .top-icons a {
      margin-left: 10px;
      color: white;
      font-size: 1.4em;
      text-decoration: none;
      padding: 5px;
    }
    .week-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .week-navigation button {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.2s;
    }
    .week-navigation button:hover {
      background: #5a6268;
    }
    #weekDisplay {
      font-weight: bold;
    }

    /* é€±è¡¨ç¤ºãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #weeklyTableContainer {
      overflow-x: auto; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¯èƒ½ã«ã™ã‚‹ */
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      padding: 10px; /* ãƒ†ãƒ¼ãƒ–ãƒ«å†…å¤–ã«ä½™ç™½ */
    }
    #weeklyTable {
      width: 100%; /* ã‚³ãƒ³ãƒ†ãƒŠã„ã£ã±ã„ã«åºƒãŒã‚‹ */
      border-collapse: collapse; /* ã‚»ãƒ«ã®å¢ƒç•Œç·šã‚’çµåˆ */
      min-width: 700px; /* ã‚¹ãƒãƒ›ã§æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹ãŸã‚ã®æœ€å°å¹… */
    }
    #weeklyTable th, #weeklyTable td {
      border: 1px solid #eee; /* ã‚»ãƒ«ã®å¢ƒç•Œç·š */
      padding: 4px 8px; /* ä¸Šä¸‹ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’4pxã« */
      text-align: left;
      vertical-align: top; /* ä¸Šæƒãˆ */
      font-size: 0.85em; /* æ–‡å­—ã‚’å°ã•ã‚ã« */
    }
    #weeklyTable th {
      background: #f8f9fa;
      font-weight: bold;
      white-space: nowrap; /* æ—¥ä»˜ãŒæ”¹è¡Œã•ã‚Œãªã„ã‚ˆã†ã« */
    }
    #weeklyTable td {
      background: white;
      line-height: 1.2; /* è¡Œé–“ã‚’èª¿æ•´ */
    }
    #weeklyTable td p {
        margin: 0;
        padding: 0;
    }
    .daily-summary {
      font-size: 0.8em;
      color: #666;
      margin-top: 3px; /* ä¸Šãƒãƒ¼ã‚¸ãƒ³ã‚’æ¸›ã‚‰ã™ */
      padding-top: 3px; /* ä¸Šãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¸›ã‚‰ã™ */
      border-top: 1px dashed #eee;
    }
    .daily-summary p {
        margin: 0;
        padding: 0;
    }
    /* ç¡çœ ä¸­ã®è¡¨ç¤ºã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .sleep-entry {
        font-style: italic; /* æ–œä½“ */
        color: #888; /* å°‘ã—è–„ã„è‰² */
        /* å¿…è¦ã«å¿œã˜ã¦ã€paddingã‚„line-heightã‚’ã•ã‚‰ã«èª¿æ•´ã—ã¦ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
    }

    /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« (A4ã‚µã‚¤ã‚ºèª¿æ•´) */
    @media print {
      body {
        margin: 0;
        padding: 0;
        max-width: none;
        width: 210mm; /* A4å¹… */
        height: 297mm; /* A4é«˜ã• */
        overflow: hidden; /* ä½™åˆ†ãªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤º */
      }
      header, .week-navigation, .top-icons { /* å°åˆ·æ™‚ã«éè¡¨ç¤ºã«ã™ã‚‹è¦ç´  */
        display: none;
      }
      #weeklyTableContainer {
        border: none;
        box-shadow: none;
        padding: 0;
        width: 100%;
        height: 100%;
        display: block; /* table-containerã‚’ãƒ–ãƒ­ãƒƒã‚¯è¦ç´ ã« */
        overflow: visible; /* å°åˆ·æ™‚ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸è¦ */
      }
      #weeklyTable {
        width: 100%;
        height: 100%;
        font-size: 0.7em; /* å°åˆ·æ™‚ã«ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’ã•ã‚‰ã«å°ã•ã */
      }
      #weeklyTable th, #weeklyTable td {
        padding: 2px 4px; /* å°åˆ·æ™‚ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ã•ã‚‰ã«èª¿æ•´ */
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>é€±é–“è¡¨ç¤º</h1>
    <div class="top-icons">
      <a href="index.html" title="æ´»å‹•è¨˜éŒ²">âœï¸</a>
      <a href="#" id="saveImageBtn" title="ç”»åƒã‚’ä¿å­˜">ğŸ“·</a>
    </div>
  </header>

  <div class="week-navigation">
    <button id="prevWeekBtn">â† å‰ã®é€±</button>
    <span id="weekDisplay"></span>
    <button id="nextWeekBtn">æ¬¡ã®é€± â†’</button>
  </div>

  <div id="weeklyTableContainer">
    <table id="weeklyTable">
      <thead>
        <tr id="dateRow">
          <th>æ™‚é–“</th>
        </tr>
      </thead>
      <tbody id="weeklyTableBody">
        </tbody>
    </table>
  </div>

  <script>
    const daysOfWeek = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
    const weeklyTableBody = document.getElementById('weeklyTableBody');
    const dateRow = document.getElementById('dateRow');
    const weekDisplay = document.getElementById('weekDisplay');
    const prevWeekBtn = document.getElementById('prevWeekBtn');
    const nextWeekBtn = document.getElementById('nextWeekBtn');
    const saveImageBtn = document.getElementById('saveImageBtn');

    let currentMonday = getMonday(new Date()); // ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹é€±ã®æœˆæ›œæ—¥

    // æŒ‡å®šã•ã‚ŒãŸæ—¥ä»˜ã®é€±ã®æœˆæ›œæ—¥ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function getMonday(date) {
      const d = new Date(date);
      const day = d.getDay(); // 0 = æ—¥æ›œ, 1 = æœˆæ›œ, ...
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); // æœˆæ›œæ—¥ã«èª¿æ•´ (æ—¥æ›œæ—¥ã®å ´åˆã¯å‰ã®æœˆæ›œã¸)
      d.setDate(diff);
      d.setHours(0, 0, 0, 0); // æ™‚é–“ã‚’ãƒªã‚»ãƒƒãƒˆ
      return d;
    }

    // æ—¥ä»˜ã‚’ "MM/DD(æ›œæ—¥)" å½¢å¼ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function formatDate(date) {
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      const dayOfWeek = daysOfWeek[date.getDay()];
      return `${month}/${day}(${dayOfWeek})`;
    }

    // é€±ã®è¡¨ç¤ºç¯„å›²ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateWeekDisplay() {
      const sunday = new Date(currentMonday);
      sunday.setDate(currentMonday.getDate() + 6);
      weekDisplay.textContent = `${formatDate(currentMonday)} - ${formatDate(sunday)}`;
    }

    // é€±è¡¨ç¤ºãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
    function renderWeeklyTable() {
      dateRow.innerHTML = '<th>æ™‚é–“</th>'; // æ™‚é–“åˆ—ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’åˆæœŸåŒ–
      weeklyTableBody.innerHTML = ''; // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœãƒ‡ã‚£ã‚’ã‚¯ãƒªã‚¢

      const datesInWeek = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(currentMonday);
        date.setDate(currentMonday.getDate() + i);
        datesInWeek.push(date);

        const th = document.createElement('th');
        th.textContent = formatDate(date);
        dateRow.appendChild(th);
      }

      // 4æ™‚ã‚¹ã‚¿ãƒ¼ãƒˆã§24æ™‚é–“åˆ†ã®è¡Œã‚’ç”Ÿæˆ
      for (let i = 0; i < 24; i++) {
        const hour = (i + 4) % 24;
        const timeKey = hour.toString().padStart(2, '0');
        
        const tr = document.createElement('tr');
        const timeCell = document.createElement('td');
        timeCell.textContent = `${timeKey}:00`;
        tr.appendChild(timeCell);

        datesInWeek.forEach(date => {
          const td = document.createElement('td');
          const dateStr = date.toISOString().split('T')[0];
          const dailyData = JSON.parse(localStorage.getItem(dateStr) || '{}');
          const entry = dailyData[timeKey];

          if (entry) {
            // "ç¡çœ "ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const isSleeping = entry.activity.includes("ç¡çœ ");

            // ã‚„ã£ãŸã“ã¨ (å†…å®¹ã®ã¿è¡¨ç¤ºã€Pã‚¿ã‚°ã¯ç¶­æŒ)
            const activityP = document.createElement('p');
            activityP.textContent = entry.activity.join(', ') || 'â€•';
            td.appendChild(activityP);

            // ç¡çœ ä¸­ã®å ´åˆã¯æ°—åˆ†ã¨ç–²åŠ´åº¦ã‚’è¡¨ç¤ºã›ãšã€ã€Œç¡çœ ä¸­ã€ã¨è¡¨ç¤ºã—ã€ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
            if (isSleeping) {
              const sleepP = document.createElement('p');
              sleepP.textContent = 'ç¡çœ ä¸­';
              sleepP.classList.add('sleep-entry'); // æ–°ã—ã„ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
              td.appendChild(sleepP);
            } else {
              // æ°—åˆ†ã¨ç–²åŠ´åº¦ï¼ˆã€Œç¡çœ ã€ã§ã¯ãªã„å ´åˆã®ã¿è¡¨ç¤ºï¼‰
              const moodFatigueP = document.createElement('p');
              // æ°—åˆ†â†’æ°—, ç–²åŠ´åº¦â†’ç–² ã§1è¡Œã«ã¾ã¨ã‚ã‚‹
              moodFatigueP.textContent = `æ°—: ${entry.mood === '' || entry.mood === null ? 'â€•' : entry.mood} ç–²: ${entry.fatigue === '' || entry.fatigue === null ? 'â€•' : entry.fatigue}`;
              td.appendChild(moodFatigueP);
            }
            
            // è‡ªç”±è¨˜å…¥æ¬„ (é …ç›®åã¯ç¶­æŒ)
            if (entry.free) {
                const freeTxtP = document.createElement('p');
                freeTxtP.textContent = `ãƒ¡ãƒ¢: ${entry.free}`; // ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«çµ±ä¸€
                td.appendChild(freeTxtP);
            }
          } else {
            td.textContent = 'â€•'; // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
          }

          // DailyNoteã®ã‚µãƒãƒªãƒ¼ã‚’ã‚»ãƒ«ã®ä¸‹éƒ¨ã«è¿½åŠ 
          const dailyNote = dailyData.dailyNote;
          if (dailyNote && (dailyNote.alcohol || dailyNote.caffeine || dailyNote.intakeMemo || dailyNote.memo)) {
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'daily-summary';
            // å„é …ç›®ã¯Pã‚¿ã‚°ã§åŒ…ã¿ã€æ”¹è¡Œã•ã›ã‚‹
            if (dailyNote.alcohol) summaryDiv.innerHTML += '<p>ãƒ»ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«æ‘‚å–</p>';
            if (dailyNote.caffeine) summaryDiv.innerHTML += '<p>ãƒ»ã‚«ãƒ•ã‚§ã‚¤ãƒ³æ‘‚å–</p>';
            if (dailyNote.intakeMemo) summaryDiv.innerHTML += `<p>ãƒ»æ‘‚å–çŠ¶æ³: ${dailyNote.intakeMemo}</p>`;
            if (dailyNote.memo) summaryDiv.innerHTML += `<p>ãƒ»æ—¥ãƒ¡ãƒ¢: ${dailyNote.memo}</p>`;
            td.appendChild(summaryDiv);
          }

          tr.appendChild(td);
        });
        weeklyTableBody.appendChild(tr);
      }
      updateWeekDisplay();
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    prevWeekBtn.addEventListener('click', () => {
      currentMonday.setDate(currentMonday.getDate() - 7);
      renderWeeklyTable();
    });

    nextWeekBtn.addEventListener('click', () => {
      currentMonday.setDate(currentMonday.getDate() + 7);
      renderWeeklyTable();
    });

    // ç”»åƒä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    saveImageBtn.addEventListener('click', async (e) => {
        e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒªãƒ³ã‚¯å‹•ä½œã‚’é˜²æ­¢

        const element = document.getElementById('weeklyTableContainer');

        // å°åˆ·ç”¨CSSã‚’é©ç”¨ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ«è¦ç´ ã‚’ä½œæˆ
        const printStyle = document.createElement('style');
        printStyle.id = 'print-style'; // å¾Œã§å‰Šé™¤ã™ã‚‹ãŸã‚ã«IDã‚’è¨­å®š
        printStyle.innerHTML = `
            body { margin: 0; padding: 0; max-width: none; width: 210mm; height: 297mm; overflow: hidden; }
            header, .week-navigation, .top-icons { display: none !important; } /* !importantã§å„ªå…ˆ */
            #weeklyTableContainer {
                border: none; box-shadow: none; padding: 0;
                width: 100%; height: 100%; display: block; overflow: visible;
            }
            #weeklyTable { width: 100%; height: 100%; font-size: 0.7em; }
            #weeklyTable th, #weeklyTable td { padding: 2px 4px; }
        `;
        document.head.appendChild(printStyle);

        // html2canvasã§è¦ç´ ã‚’ç”»åƒåŒ–
        const canvas = await html2canvas(element, {
            scale: 2, // é«˜è§£åƒåº¦ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            useCORS: true,
            // æç”»ã™ã‚‹è¦ç´ ã®ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¹…ã¨é«˜ã•ã‚’ãã®ã¾ã¾ä½¿ç”¨
            windowWidth: element.scrollWidth, 
            windowHeight: element.scrollHeight,
            // x, y, width, height ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§è¦ç´ ã®å…¨ä½“ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
            x: element.scrollLeft,
            y: element.scrollTop,
            width: element.scrollWidth,
            height: element.scrollHeight,
        });

        // Canvasã‚’A4ã‚µã‚¤ã‚ºã«ãƒˆãƒªãƒŸãƒ³ã‚°ã¾ãŸã¯ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
        const a4WidthPx = 210 / 25.4 * 96; // A4å¹… (mm) ã‚’pxã«å¤‰æ› (96dpiã®å ´åˆ)
        const a4HeightPx = 297 / 25.4 * 96; // A4é«˜ã• (mm) ã‚’pxã«å¤‰æ›

        const outputCanvas = document.createElement('canvas');
        outputCanvas.width = a4WidthPx;
        outputCanvas.height = a4HeightPx;
        const ctx = outputCanvas.getContext('2d');

        // å…ƒã®canvasã®å†…å®¹ã‚’outputCanvasã«æç”»ï¼ˆA4ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦èª¿æ•´ï¼‰
        // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿ã¡ã¤ã¤ã€A4ã‚µã‚¤ã‚ºã«ãƒ•ã‚£ãƒƒãƒˆã•ã›ã‚‹
        const canvasAspectRatio = canvas.width / canvas.height;
        const a4AspectRatio = a4WidthPx / a4HeightPx;

        let drawWidth, drawHeight;
        if (canvasAspectRatio > a4AspectRatio) {
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒA4ã‚ˆã‚Šæ¨ªé•·ã®å ´åˆã€å¹…ã‚’A4ã«åˆã‚ã›é«˜ã•ã‚’èª¿æ•´
            drawWidth = a4WidthPx;
            drawHeight = a4WidthPx / canvasAspectRatio;
        } else {
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒA4ã‚ˆã‚Šç¸¦é•·ã¾ãŸã¯åŒã˜æ¯”ç‡ã®å ´åˆã€é«˜ã•ã‚’A4ã«åˆã‚ã›å¹…ã‚’èª¿æ•´
            drawHeight = a4HeightPx;
            drawWidth = a4HeightPx * canvasAspectRatio;
        }

        // ä¸­å¤®ã«é…ç½®
        const offsetX = (a4WidthPx - drawWidth) / 2;
        const offsetY = (a4HeightPx - drawHeight) / 2;

        ctx.drawImage(canvas, offsetX, offsetY, drawWidth, drawHeight);

        // ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const imgData = outputCanvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = imgData;
        link.download = `weekly_report_${currentMonday.toISOString().split('T')[0]}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // å°åˆ·ç”¨CSSã‚’å…ƒã«æˆ»ã™
        const styleToRemove = document.getElementById('print-style');
        if (styleToRemove) {
            document.head.removeChild(styleToRemove);
        }
    });

    // åˆæœŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    renderWeeklyTable();
  </script>
</body>
</html>
