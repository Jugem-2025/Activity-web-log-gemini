<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>週間活動内訳</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 1000px; /* 週間表示なので少し広めに */
      margin: auto;
      background: #f5f6fa;
      color: #333;
      padding: 15px;
      box-sizing: border-box;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #4a90e2;
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    header h1 {
      font-size: 1.4em;
      margin: 0;
    }
    .top-icons a {
      margin-left: 10px;
      color: white;
      font-size: 1.4em;
      text-decoration: none;
      padding: 5px;
    }
    .week-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .week-navigation button {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.2s;
    }
    .week-navigation button:hover {
      background: #5a6268;
    }
    #weekDisplay {
      font-weight: bold;
    }

    /* 週表示テーブルのスタイル */
    #weeklyTableContainer {
      overflow-x: auto; /* 横スクロールを可能にする */
      background: white;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      padding: 10px; /* テーブル内外に余白 */
    }
    #weeklyTable {
      width: 100%; /* コンテナいっぱいに広がる */
      border-collapse: collapse; /* セルの境界線を結合 */
      min-width: 700px; /* スマホで横スクロールさせるための最小幅 */
    }
    #weeklyTable th, #weeklyTable td {
      border: 1px solid #eee; /* セルの境界線 */
      padding: 4px 8px; /* 上下パディングを4pxに */
      text-align: left;
      vertical-align: top; /* 上揃え */
      font-size: 0.85em; /* 文字を小さめに */
    }
    #weeklyTable th {
      background: #f8f9fa;
      font-weight: bold;
      white-space: nowrap; /* 日付が改行されないように */
    }
    #weeklyTable td {
      background: white;
      line-height: 1.2; /* 行間を調整 */
    }
    #weeklyTable td p {
        margin: 0;
        padding: 0;
    }
    .daily-summary {
      font-size: 0.8em;
      color: #666;
      margin-top: 3px; /* 上マージンを減らす */
      padding-top: 3px; /* 上パディングを減らす */
      border-top: 1px dashed #eee;
    }
    .daily-summary p {
        margin: 0;
        padding: 0;
    }
    /* 睡眠中の表示をコンパクトにするためのスタイル */
    .sleep-entry {
        font-style: italic; /* 斜体 */
        color: #888; /* 少し薄い色 */
        /* 必要に応じて、paddingやline-heightをさらに調整してコンパクトに */
    }

    /* 新しいスタイル：各日付セル内のレイアウト */
    .activity-cell-content {
      display: flex;
      flex-wrap: nowrap; /* 折り返しを禁止 */
      justify-content: space-between; /* 要素間にスペースを均等に配置 */
      align-items: flex-start; /* 上揃え */
      width: 100%; /* 親セルに合わせる */
      min-height: 1em; /* 空の場合でも高さを持つ */
    }
    .activity-cell-content .activity-text {
        flex: 0 0 70%; /* やったこと：約7割 */
        word-break: break-all; /* 長い単語でも強制改行 */
    }
    .activity-cell-content .mood-fatigue {
        flex: 0 0 30%; /* 気分・疲労度：約3割 */
        display: flex;
        flex-direction: column;
        align-items: flex-end; /* 右揃え */
        white-space: nowrap; /* 改行禁止 */
        font-size: 0.9em;
        line-height: 1.1;
    }
    .activity-cell-content .mood-fatigue p {
        margin: 0;
    }
    /* 自由記入欄のスタイルはそのまま */
    .activity-cell-content ~ p { /* .activity-cell-content の後の p タグに適用 */
        font-size: 0.8em;
        color: #555;
    }


    /* 印刷用スタイル (横長A4サイズ調整) */
    @media print {
      body {
        margin: 0 !important;
        /* 左3%, 右2% の余白 = (3% + 2%) = 5% */
        /* 上1%, 下1% の余白 = (1% + 1%) = 2% */
        /* A4横長 (297mm x 210mm) */
        padding: calc(210mm * 0.01) calc(297mm * 0.02) calc(210mm * 0.01) calc(297mm * 0.03) !important;
        max-width: none !important;
        width: 297mm !important; 
        height: 210mm !important; 
        overflow: hidden !important;
        display: block !important;
        box-sizing: border-box !important;
        background-color: white !important; 
      }
      header, .week-navigation, .top-icons { 
        display: none !important;
      }
      #weeklyTableContainer {
        border: none !important;
        box-shadow: none !important;
        padding: 0 !important;
        width: 100% !important; /* bodyのpaddingを除いた残りの100% */
        height: 100% !important; /* bodyのpaddingを除いた残りの100% */
        display: block !important;
        overflow: visible !important;
        box-sizing: border-box !important;
      }
      #weeklyTable {
        width: 100% !important;
        height: 100% !important;
        border-collapse: collapse !important;
        table-layout: fixed !important; 
        font-size: 0.5em !important; 
      }

      /* 列幅の調整 */
      #weeklyTable thead tr th:first-child,
      #weeklyTable tbody tr td:first-child {
        width: 4% !important; /* '時間' 列 4% */
        min-width: 0 !important; 
      }
      #weeklyTable thead tr th:not(:first-child),
      #weeklyTable tbody tr td:not(:first-child) {
        width: 13% !important; /* 各日付列 13% */
        min-width: 0 !important; 
      }

      /* 行高の調整 */
      #weeklyTable thead tr {
        height: 2% !important; /* 日付と曜日の行 2% */
      }
      #weeklyTable tbody tr {
        height: 4% !important; /* 各時間帯の行 4% (24行) */
      }
      /* 備考行は時間帯の行と同じ高さにするか、別途調整が必要です。
         ここでは各時間帯の行の高さに含めて、合計25行として調整します。
         96% (時間帯) + 2% (日付) + 1% (上) + 1% (下) = 100%
         今回の要望では時間帯の行が96%を占めるため、備考行もその一部として扱います。
         tbodyの最後の行が備考行になります。
      */
      #weeklyTable tbody tr:last-child {
          height: 4% !important; /* 備考行も4%としてカウント */
      }


      #weeklyTable th, #weeklyTable td {
        border: 1px solid black !important; /* 罫線を実線に */
        padding: 1mm 1mm !important; /* 印刷時のパディングを調整（ミリメートル単位） */
        vertical-align: top !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        word-wrap: break-word; /* 長い単語の折り返し */
      }
      #weeklyTable td p {
        margin: 0 !important;
        padding: 0 !important;
        line-height: 1.1 !important;
      }
      .daily-summary {
        margin-top: 1mm !important;
        padding-top: 1mm !important;
        border-top: 1px solid #ddd !important; /* 実線に */
        font-size: 0.9em !important;
      }
      .daily-summary p {
        font-size: 1em !important; 
      }

      /* 各日付セル内のレイアウト（印刷時） */
      .activity-cell-content {
        flex-direction: row !important; /* 横並びを保証 */
        flex-wrap: nowrap !important;
      }
      .activity-cell-content .activity-text {
          flex: 0 0 69% !important; /* 9%に相当 (全体の13%中の9%) */
          font-size: 0.9em !important;
      }
      .activity-cell-content .mood-fatigue {
          flex: 0 0 31% !important; /* 4%に相当 (全体の13%中の2%+2%) */
          font-size: 0.9em !important;
      }
      .mood-fatigue .mood-value, .mood-fatigue .fatigue-value {
          display: inline-block !important; /* 横並びにするためにインラインブロック */
          width: 50% !important; /* 気分と疲労度をそれぞれ半分に */
          text-align: right !important; /* 右寄せ */
          padding-left: 1px !important;
      }
      .mood-fatigue .fatigue-value {
          border-left: 1px solid #eee !important; /* 区切り線 */
      }

      /* 自由記入欄の調整 */
      .activity-cell-content ~ p {
          font-size: 0.8em !important;
          margin-top: 1mm !important;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>週間表示</h1>
    <div class="top-icons">
      <a href="index.html" title="活動記録">✏️</a>
      <a href="#" id="saveImageBtn" title="画像を保存">📷</a>
    </div>
  </header>

  <div class="week-navigation">
    <button id="prevWeekBtn">← 前の週</button>
    <span id="weekDisplay"></span>
    <button id="nextWeekBtn">次の週 →</button>
  </div>

  <div id="weeklyTableContainer">
    <table id="weeklyTable">
      <thead>
        <tr id="dateRow">
          <th>時間</th>
        </tr>
      </thead>
      <tbody id="weeklyTableBody">
        </tbody>
    </table>
  </div>

  <script>
    const daysOfWeek = ["日", "月", "火", "水", "木", "金", "土"];
    const weeklyTableBody = document.getElementById('weeklyTableBody');
    const dateRow = document.getElementById('dateRow');
    const weekDisplay = document.getElementById('weekDisplay');
    const prevWeekBtn = document.getElementById('prevWeekBtn');
    const nextWeekBtn = document.getElementById('nextWeekBtn');
    const saveImageBtn = document.getElementById('saveImageBtn');

    let currentMonday = getMonday(new Date()); // 現在表示している週の月曜日

    // 指定された日付の週の月曜日を取得する関数 (UTC基準)
    function getMonday(date) {
        const d = new Date(date);
        // UTCの曜日を取得 (0=日曜, 1=月曜...)
        const day = d.getUTCDay();
        // UTCの日付を月曜日に調整
        // 日曜(0)の場合は6日前 (前の週の月曜日)
        // 月曜(1)の場合は0日前
        // 火曜(2)の場合は1日前 ...
        const diff = d.getUTCDate() - day + (day === 0 ? -6 : 1);
        d.setUTCDate(diff);
        d.setUTCHours(0, 0, 0, 0); // 時間をリセット (UTC)
        return d;
    }

    // 日付を "MM/DD(曜日)" 形式でフォーマット (ローカルタイムゾーンで表示)
    function formatDate(date) {
      // Dateオブジェクトをローカルタイムゾーンで解釈し直す
      const localDate = new Date(date.getFullYear(), date.getMonth(), date.getDate()); 
      const month = (localDate.getMonth() + 1).toString().padStart(2, '0');
      const day = localDate.getDate().toString().padStart(2, '0');
      const dayOfWeek = daysOfWeek[localDate.getDay()]; // ローカル曜日
      return `${month}/${day}(${dayOfWeek})`;
    }

    // 週の表示範囲を更新する関数
    function updateWeekDisplay() {
      const sunday = new Date(currentMonday);
      sunday.setUTCDate(currentMonday.getUTCDate() + 6); // UTCで6日加算
      weekDisplay.textContent = `${formatDate(currentMonday)} - ${formatDate(sunday)}`;
    }

    // 週表示テーブルをレンダリングする関数
    function renderWeeklyTable() {
      dateRow.innerHTML = '<th>時間</th>'; // 時間列のヘッダーを初期化
      weeklyTableBody.innerHTML = ''; // テーブルボディをクリア

      const datesInWeek = [];
      for (let i = 0; i < 7; i++) {
        const date = new Date(currentMonday);
        date.setUTCDate(currentMonday.getUTCDate() + i); // UTCで日付を進める
        datesInWeek.push(date);

        const th = document.createElement('th');
        th.textContent = formatDate(date);
        dateRow.appendChild(th);
      }

      // 各時間帯の行を生成 (4:00 から翌日の3:00 まで)
      for (let i = 0; i < 24; i++) {
        const hour = (i + 4) % 24;
        const timeKey = hour.toString().padStart(2, '0');
        
        const tr = document.createElement('tr');
        const timeCell = document.createElement('td');
        timeCell.textContent = `${timeKey}:00`;
        tr.appendChild(timeCell);

        datesInWeek.forEach(date => {
          const td = document.createElement('td');
          const dateStr = date.toISOString().split('T')[0];
          const dailyData = JSON.parse(localStorage.getItem(dateStr) || '{}');
          const entry = dailyData[timeKey];

          if (entry) {
            const isSleeping = entry.activity.includes("睡眠");

            const cellContentDiv = document.createElement('div');
            cellContentDiv.className = 'activity-cell-content';

            // やったこと
            const activityTextDiv = document.createElement('div');
            activityTextDiv.className = 'activity-text';
            activityTextDiv.textContent = entry.activity.join(', ') || '―';
            cellContentDiv.appendChild(activityTextDiv);

            // 睡眠中でない場合のみ気分・疲労度を表示
            if (!isSleeping) {
              const moodFatigueDiv = document.createElement('div');
              moodFatigueDiv.className = 'mood-fatigue';
              
              const moodP = document.createElement('p');
              moodP.className = 'mood-value';
              moodP.textContent = `気: ${entry.mood === '' || entry.mood === null ? '―' : entry.mood}`;
              
              const fatigueP = document.createElement('p');
              fatigueP.className = 'fatigue-value';
              fatigueP.textContent = `疲: ${entry.fatigue === '' || entry.fatigue === null ? '―' : entry.fatigue}`;

              moodFatigueDiv.appendChild(moodP);
              moodFatigueDiv.appendChild(fatigueP);
              cellContentDiv.appendChild(moodFatigueDiv);
            }
            
            td.appendChild(cellContentDiv);

            // 自由記入欄 (これは `activity-cell-content` の後に続く p タグとしてそのまま)
            if (entry.free) {
                const freeTxtP = document.createElement('p');
                freeTxtP.textContent = `メモ: ${entry.free}`;
                td.appendChild(freeTxtP);
            }
          } else {
            // データがない場合も空の Flexbox コンテナを用意し、
            // 高さを一定に保つためのプレースホルダーを挿入
            const cellContentDiv = document.createElement('div');
            cellContentDiv.className = 'activity-cell-content';
            cellContentDiv.innerHTML = '<div class="activity-text">―</div><div class="mood-fatigue"></div>';
            td.appendChild(cellContentDiv);
          }
          tr.appendChild(td);
        });
        weeklyTableBody.appendChild(tr);
      }

      // デイリーノートのサマリー行を生成
      const dailyNoteTr = document.createElement('tr');
      const dailyNoteHeader = document.createElement('th');
      dailyNoteHeader.textContent = '備考'; // ヘッダーを「備考」に変更
      dailyNoteTr.appendChild(dailyNoteHeader);

      datesInWeek.forEach(date => {
        const td = document.createElement('td');
        const dateStr = date.toISOString().split('T')[0];
        const dailyData = JSON.parse(localStorage.getItem(dateStr) || '{}');
        const dailyNote = dailyData.dailyNote;

        if (dailyNote && (dailyNote.alcohol || dailyNote.caffeine || dailyNote.intakeMemo || dailyNote.memo)) {
          const summaryDiv = document.createElement('div');
          summaryDiv.className = 'daily-summary'; // スタイルは既存のものを再利用

          if (dailyNote.alcohol) summaryDiv.innerHTML += '<p>・アルコール摂取</p>';
          if (dailyNote.caffeine) summaryDiv.innerHTML += '<p>・カフェイン摂取</p>';
          if (dailyNote.intakeMemo) summaryDiv.innerHTML += `<p>・摂取状況: ${dailyNote.intakeMemo}</p>`;
          if (dailyNote.memo) summaryDiv.innerHTML += `<p>・日メモ: ${dailyNote.memo}</p>`;
          td.appendChild(summaryDiv);
        } else {
          td.textContent = '―'; // データがない場合
        }
        dailyNoteTr.appendChild(td);
      });
      weeklyTableBody.appendChild(dailyNoteTr); // テーブルボディの最後に追加

      updateWeekDisplay();
    }

    // イベントリスナー
    prevWeekBtn.addEventListener('click', () => {
      currentMonday.setUTCDate(currentMonday.getUTCDate() - 7); // UTCで7日減算
      renderWeeklyTable();
    });

    nextWeekBtn.addEventListener('click', () => {
      currentMonday.setUTCDate(currentMonday.getUTCDate() + 7); // UTCで7日加算
      renderWeeklyTable();
    });

    // 画像保存ボタンのイベントリスナー
    saveImageBtn.addEventListener('click', async (e) => {
        e.preventDefault(); // デフォルトのリンク動作を防止

        const element = document.body; // body全体を対象

        // 印刷用CSSを一時的に適用
        const printStyle = document.createElement('style');
        printStyle.id = 'print-style-for-capture'; // 後で削除するためにIDを設定

        // A4サイズ（横長）のミリメートル値
        const a4WidthMm = 297;
        const a4HeightMm = 210;

        printStyle.innerHTML = `
            body {
                margin: 0 !important;
                /* 左3%, 右2% の余白 = (3% + 2%) = 5% */
                /* 上1%, 下1% の余白 = (1% + 1%) = 2% */
                padding: calc(${a4HeightMm}mm * 0.01) calc(${a4WidthMm}mm * 0.02) calc(${a4HeightMm}mm * 0.01) calc(${a4WidthMm}mm * 0.03) !important;
                max-width: none !important;
                width: ${a4WidthMm}mm !important; 
                height: ${a4HeightMm}mm !important; 
                overflow: hidden !important;
                display: block !important;
                box-sizing: border-box !important;
                background-color: white !important; 
            }
            header, .week-navigation, .top-icons {
                display: none !important;
            }
            #weeklyTableContainer {
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                width: 100% !important; 
                height: 100% !important; 
                display: block !important;
                overflow: visible !important;
                box-sizing: border-box !important;
            }
            #weeklyTable {
                width: 100% !important;
                height: 100% !important;
                border-collapse: collapse !important;
                table-layout: fixed !important; /* カラム幅を固定 */
                font-size: 0.5em !important; 
            }

            /* 列幅の調整 */
            #weeklyTable thead tr th:first-child,
            #weeklyTable tbody tr td:first-child {
                width: 4% !important; /* '時間' 列 4% */
                min-width: 0 !important; 
            }
            #weeklyTable thead tr th:not(:first-child),
            #weeklyTable tbody tr td:not(:first-child) {
                width: 13% !important; /* 各日付列 13% */
                min-width: 0 !important; 
            }

            /* 行高の調整 */
            #weeklyTable thead tr {
                height: 2% !important; /* 日付と曜日の行 2% */
            }
            #weeklyTable tbody tr {
                height: 4% !important; /* 各時間帯の行 4% (24行) */
            }
            /* 備考行も時間帯の行と同じ高さにする */
            #weeklyTable tbody tr:last-child {
                height: 4% !important; 
            }


            #weeklyTable th, #weeklyTable td {
                border: 1px solid black !important; /* 罫線を実線に */
                padding: 1mm 1mm !important; 
                vertical-align: top !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                word-wrap: break-word; /* 長い単語の折り返し */
            }
            #weeklyTable td p {
                margin: 0 !important;
                padding: 0 !important;
                line-height: 1.1 !important;
            }
            .daily-summary {
                margin-top: 1mm !important;
                padding-top: 1mm !important;
                border-top: 1px solid black !important; /* 実線に */
                font-size: 0.9em !important;
            }
            .daily-summary p {
                font-size: 1em !important; 
            }

            /* 各日付セル内のレイアウト（印刷時） */
            .activity-cell-content {
                display: flex !important;
                flex-direction: row !important; /* 横並びを保証 */
                flex-wrap: nowrap !important;
                justify-content: space-between !important;
                align-items: flex-start !important;
                width: 100% !important;
            }
            .activity-cell-content .activity-text {
                flex: 0 0 69% !important; /* 9%に相当 (全体の13%中の9%) */
                font-size: 0.9em !important;
            }
            .activity-cell-content .mood-fatigue {
                flex: 0 0 31% !important; /* 4%に相当 (全体の13%中の2%+2%) */
                display: flex !important;
                flex-direction: row !important; /* 気分と疲労度を横並びにする */
                align-items: flex-start !important;
                font-size: 0.9em !important;
            }
            .mood-fatigue .mood-value, .mood-fatigue .fatigue-value {
                display: inline-block !important; /* 横並びにするためにインラインブロック */
                width: 50% !important; /* 気分と疲労度をそれぞれ半分に */
                text-align: right !important; /* 右寄せ */
                padding-left: 1px !important;
            }
            .mood-fatigue .fatigue-value {
                border-left: 1px solid #eee !important; /* 区切り線 */
            }

            /* 自由記入欄の調整 */
            .activity-cell-content ~ p {
                font-size: 0.8em !important;
                margin-top: 1mm !important;
            }
        `;
        document.head.appendChild(printStyle);

        // html2canvasで要素を画像化
        const canvas = await html2canvas(element, {
            scale: 2, // 高解像度でレンダリング
            useCORS: true,
            windowWidth: element.scrollWidth, 
            windowHeight: element.scrollHeight,
            x: 0,
            y: 0,
            width: element.offsetWidth,
            height: element.offsetHeight,
        });

        // A4サイズ（横長）のピクセル値を計算 (300dpi想定)
        const dpi = 300; 
        const mmPerInch = 25.4;
        const a4LandscapeWidthPx = (a4WidthMm / mmPerInch) * dpi; 
        const a4LandscapeHeightPx = (a4HeightMm / mmPerInch) * dpi; 

        const outputCanvas = document.createElement('canvas');
        outputCanvas.width = a4LandscapeWidthPx;
        outputCanvas.height = a4LandscapeHeightPx;
        const ctx = outputCanvas.getContext('2d');

        // 背景を白で塗りつぶす（透過を防ぐため）
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, outputCanvas.width, outputCanvas.height);

        // 元のcanvasの内容をoutputCanvasに描画（A4サイズにフィットさせる）
        ctx.drawImage(canvas, 0, 0, outputCanvas.width, outputCanvas.height);

        // 画像をダウンロード
        const imgData = outputCanvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = imgData;
        link.download = `weekly_report_${currentMonday.toISOString().split('T')[0]}_A4L.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // 印刷用CSSを元に戻す
        const styleToRemove = document.getElementById('print-style-for-capture');
        if (styleToRemove) {
            document.head.removeChild(styleToRemove);
        }

        // html2canvas適用中にbodyに付与された可能性のあるスタイルをリセット
        document.body.style.cssText = ''; 
    });

    // 初期レンダリング
    renderWeeklyTable();
  </script>
</body>
</html>
